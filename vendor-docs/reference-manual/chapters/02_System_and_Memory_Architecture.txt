WB32FQ95xx Reference Manual

2.

System and memory architecture
The devices of WB32FQ95xx series are 32-bit general-purpose microcontrollers based on
the ARM® Cortex™-M3 processor. The ARM® Cortex™-M3 processor includes three AHB
buses known as I-Code, D-Code and System buses. All memory accesses of the ARM®
Cortex™- M3 processor are executed on the three buses according to the different purposes
and the target memory spaces. The memory organization uses a Harvard architecture,
predefined memory map and up to 4 GB of memory space, making the system flexible and
extendable.

2.1.

ARM Cortex-M3 processor
The Cortex™-M3 processor is a 32-bit processor that features low interrupt latency and lowcost debug. Integrated and advanced features make the Cortex™-M3 processor suitable for
market products that require micro controllers with high performance and low power
consumption. The Cortex™-M3 processor is based on the ARMv7 architecture and supports a
powerful and scalable instruction set including general data processing I/O control tasks and
advanced data processing bit field manipulations. Some system peripherals listed below are
also provided by Cortex™-M3:
⚫

Internal Bus Matrix connected with I-Code bus, D-Code bus, System bus, Private
Peripheral Bus (PPB) and debug access.
◼

Nested Vectored Interrupt Controller (NVIC)

◼

Flash Patch and Breakpoint (FPB)

◼

Data Watchpoint and Trace (DWT)

◼

Instrumentation Trace Macrocell (ITM)

◼

Serial Wire JTAG Debug Port (SWJ-DP)

◼

Trace Port Interface Unit (TPIU)

The figure below shows the Cortex™-M3 processor block diagram. For more information,
refer to the ARM® Cortex™-M3 Technical Reference Manual.

Doc ID 2905025

Rev01

26

WB32FQ95xx Reference Manual

Figure 2-1. The structure of the Cortex™-M3 processor

2.2.

System architecture
A 32-bit multi-layer bus is implemented in the WB32FQ95xx devices, which enables parallel
access paths between multiple masters and slaves in the system. The multi-layer bus consists
of an AHB interconnect matrix, one AHB bus and two APB buses . The interconnection
relationship of the AHB interconnect matrix is shown below. In the following table, “1” indicates
the corresponding master is able to access the corresponding slave through the AHB
interconnect matrix, while the blank means the corresponding master cannot access the
corresponding slave through the AHB interconnect matrix.
Table 2-1. The interconnection relationship of the AHB interconnect matrix
IBUS

FMC-I
FMC-D

DBUS

SBUS

DMA1

DMA2

1

1

1
1

SRAM

1

1

1

AHB

1

1

1

APB1

1

1

Doc ID 2905025

USB

Rev01

1(1)

27

WB32FQ95xx Reference Manual

APB2

1

1

As is shown above, there are several masters connected with the AHB interconnect matrix,
including IBUS, DBUS, SBUS, DMA1, DMA2 and USB. IBUS is the instruction bus of the
Cortex™-M3 core, which is used for instruction/vector fetches from the Code region
(0x0000_0000 ~ 0x1FFF_FFFF). DBUS is the data bus of the Cortex™-M3 core, which is
used for loading/storing data and also for debugging access of the Code region. Similarly,
SBUS is the system bus of the Cortex™-M3 core, which is used for instruction/vector fetches,
data loading/storing and debugging access of the system regions. The System regions include
the internal SRAM region and the Peripheral region. DMA1 and DMA2 are the buses of DMA1
and DMA2 respectively. USB is the USB device, and it can only access part of SRAM region
(1KB).
There are also several slaves connected with the AHB interconnect matrix, including FMC- I,
FMC-D, SRAM, AHB, APB1 and APB2. FMC- I is the instruction bus of the flash memory
controller, while FMC-D is the data bus of the flash memory controller. SRAM is on- chip
static random access memories. AHB is the AHB bus connected with all of the AHB slaves,
while APB1 and APB2 are the two APB buses connected with all of the APB slaves. The two
APB buses connect with all the APB peripherals. APB1 and APB2 operate at full speed (up
to 128MHz depending on the device).
These are interconnected using a multilayer AHB bus architecture as shown in figure below:
Figure 2-2. WB32FQ95xx Medium-density series system architecture

Doc ID 2905025

Rev01

28

WB32FQ95xx Reference Manual

2.3.

Memory map
The ARM® Cortex™-M3 processor is structured in Harvard architecture which can use
separate buses to fetch instructions and load/store data. The instruction code and data are
both located in the same memory address space but in different address ranges. Program
memory, data memory, registers and I/O ports are organized within the same linear 4-Gbyte
address space which is the maximum address range of the Cortex™-M3 since the bus
address width is 32-bit. Additionally, a pre-defined memory map is provided by the Cortex™M3 processor to reduce the software complexity of repeated implementation of different
device vendors. In the map, some regions are used by the ARM® Cortex™-M3 system
peripherals which can not be modified. However, the other regions are available to the vendors.
Table 2-2. Memory map of WB32FQ95xx devices shows the memory map of the
WB32FQ95xx series devices, including Code, SRAM, peripheral, and other pre-defined
regions. Almost each peripheral is allocated 1KB of space. This allows simplifying the address
decoding for each peripheral.
Table 2-2. Memory map of WB32FQ95xx devices

Doc ID 2905025

Rev01

29

WB32FQ95xx Reference Manual

Pre-defined Regions
Bus

AHB

Boundary Address

Peripheral

0x4002 0000 - 0x4002 FFFF

Reserved

0x4001 7C00 - 0x4001 FFFF

Reserved

0x4001 7800 - 0x4001 7BFF

FMC

0x4001 6800 - 0x4001 77FF

Reserved

0x4001 6400 ­ 0x4001 67FF

SYS

0x4001 6000 ­ 0x4001 63FF

Reserved

0x4001 5C00 ­ 0x4001 5FFF

BKP

0x4001 5800 ­ 0x4001 5BFF

RTC

0x4001 5400 - 0x4001 57FF

CACHE

0x4001 5000 - 0x4001 53FF

Reserved

0x4001 4C00 - 0x4001 4FFF

SFM

0x4001 4800 - 0x4001 4BFF

CRC

0x4001 4400 - 0x4001 47FF

Reserved

0x4001 4000 - 0x4001 43FF

USB

0x4001 1000 - 0x4001 3FFF

Reserved

0x4001 0C00 - 0x4001 0FFF

RCC

0x4001 0800 - 0x4001 0BFF

IWDG

0x4001 0400 - 0x4001 07FF

ANCTL

0x4001 0000 - 0x4001 03FF

PWR

0x4000 FC00 - 0x4000 FFFF

DMAC2

0x4000 BC00 - 0x4000 FBFF

Reserved

0x4000 B800 - 0x4000 BBFF

Reserved

0x4000 B400 - 0x4000 B7FF

Reserved

0x4000 9C00 - 0x4000 B3FF

Reserved

0x4000 9800 - 0x4000 9BFF

WWDG

0x4000 9400 - 0x4000 97FF

SPIS2

0x4000 9000 - 0x4000 93FF

SPIM2

0x4000 8C00 - 0x4000 8FFF

I2C2

0x4000 8800 - 0x4000 8BFF

I2C1

0x4000 8400 - 0x4000 87FF

UART3

Peripheral

APB2

Doc ID 2905025

Rev01

30

WB32FQ95xx Reference Manual

Pre-defined Regions
Bus

Boundary Address

Peripheral

0x4000 8000 - 0x4000 83FF

UART2

0x4000 7C00 - 0x4000 7FFF

DMAC1

0x4000 4000 - 0x4000 7BFF

Reserved

0x4000 3C00 - 0x4000 3FFF

ADC

0x4000 3800 - 0x4000 3BFF

UART1

0x4000 3400 - 0x4000 37FF

SPIS1

0x4000 3000 - 0x4000 33FF

QSPI

0x4000 2C00 - 0x4000 2FFF

Reserved

0x4000 2800 - 0x4000 2BFF

TIM4

0x4000 2400 - 0x4000 27FF

TIM3

0x4000 2000 - 0x4000 23FF

TIM2

0x4000 1C00 - 0x4000 1FFF

TIM1

0x4000 1800 - 0x4000 1BFF

EXTI

0x4000 1400 - 0x4000 17FF

AFIO

0x4000 1000 - 0x4000 13FF

Reserved

0x4000 0C00 - 0x4000 0FFF

GPIOD

0x4000 0800 - 0x4000 0BFF

GPIOC

0x4000 0400 - 0x4000 07FF

GPIOB

0x4000 0000 - 0x4000 03FF

GPIOA

0x2007 0000 - 0x3FFF FFFF

Reserved

0x2006 0000 - 0x2006 FFFF

Reserved

0x2003 0000 - 0x2005 FFFF

Reserved

0x2002 0000 - 0x2002 FFFF

Reserved

0x2001 C000 - 0x2001 FFFF

Reserved

0x2001 9000 - 0x2001 BFFF

Reserved

APB1

SRAM

AHB

0x2000 1000 - 0x2001 8FFF
SRAM
0x2000 0000 - 0x2000 0FFF

Code

Doc ID 2905025

AHB

0x1FFF F810 - 0x1FFF FFFF

Reserved

0x1FFF F000 - 0x1FFF FFFF

Option Bytes

0x1FFF E000 - 0x1FFF EFFF

Boot loader

Rev01

31

WB32FQ95xx Reference Manual

Pre-defined Regions
Bus

2.3.1.

Boundary Address

Peripheral

0x1FFF 7A10 - 0x1FFF DFFF

Reserved

0x1FFF 7800 - 0x1FFF 7A0F

Reserved

0x1FFF 0000 - 0x1FFF 77FF

Reserved

0x1FFE C010 - 0x1FFE FFFF

Reserved

0x1FFE C000 - 0x1FFE C00F

Reserved

0x1001 0000 - 0x1FFE BFFF

Reserved

0x1000 0000 - 0x1000 FFFF

Reserved

0x083C 0000 - 0x0FFF FFFF

Reserved

0x0830 0000 - 0x083B FFFF

Reserved

0x0800 0000 - 0x0804 FFFF

Main Flash

0x0004 0000 - 0x07FF FFFF

Reserved

0x0002 0000 - 0x0003 FFFF

Aliased to Main

0x0000 0000 - 0x0001 FFFF

Flash or Boot loader

Bit-banding
In order to reduce the time of read-modify-write operations, the Cortex™-M3 processor
provides a bit-banding function to perform a single atomic bit operation. The memory map
includes two bit-band regions. These occupy the SRAM and Peripherals respectively. These
bit-band regions map each word in an alias region of memory to a bit in a bit-band region of
memory.
A mapping formula shows how to reference each word in the alias region to a corresponding
bit, or target bit, in the bit-band region. The mapping formula is:
bit_word_addr = bit_band_base + (byte_offset×32) + (bit_number×4)

(1- 1)

where:
⚫

bit_word_addr is the address of the word in the alias memory region that maps to the
targeted bit.

⚫

bit_band_base is the starting address of the alias region.

⚫

byte_offset is the number of the byte in the bit-band region that contains the targeted bit.

⚫

bit_number is the bit position (0-7) of the targeted bit.

Doc ID 2905025

Rev01

32

WB32FQ95xx Reference Manual

For example, to access bit 7 of address 0x2000_0200, the bit-band alias is:
Writing to address 0x2200_401C will cause bit 7 of address 0x2000_0200 change while a
read to address 0x2200_401C will return 0x01 or 0x00 according to the value of bit 7 at the
SRAM address 0x2000_0200.

2.3.2.

On-chip SRAM memory
The WB32FQ95xx series of devices contain up to 3 6 KB of on-chip SRAM which starts at
the address 0x2000_0000. It supports byte, half-word (16 bits), and word (32 bits) access.

2.3.3.

On-chip flash memory overview
The devices provide high density on-chip flash memory, which is organized as follows:
⚫

Up to 256KB of main flash memory.

⚫

Up to 4KB of information blocks for the boot loader.

⚫

Option bytes to configure the device.

Flash Access
The instruction and data in flash is accessed through IBUS and DBUS on AHB bus. There
are two 128bit slots cache line for both IBUS and DBUS to speed up the flash access, When
IBUS and DBUS request to access flash on the same cycle, the DBUS always have the
higher priority to access the bus. The read access time should be configured according to
the system clock frequency:
1. Wait cycle: this parameter control the wait cycle number for each read operation.
2. Pre-fetch: the pre-fetch function is turned on by default, the pre-fetch buffer has two 128bit
slots which is the same width as the flash bus. Since CPU fetches 32-bit instruction each
time so there are four instructions in the buffer for a pre-fetch operation.
Note: These options should be configured according to the system clock frequency:
system frequency ≤ 32Mhz

A. 0 wait cycle, when

Doc ID 2905025

B. 1 wait cycle, when

32Mhz

<

system frequency ≤ 48Mhz

C. 2 wait cycle, when

48Mhz

<

system frequency ≤ 72Mhz

D. 3 wait cycle, when

72Mhz

<

system frequency ≤ 96Mhz

Rev01

33

WB32FQ95xx Reference Manual

E. 4 wait cycle, when

96Mhz

<

system frequency ≤ 128Mhz

When system frequency is higher than 96MHz, the HIFREQ bit in CACHE_CR SFR should
be set.

2.4.

Program and Erase
The flash can be erased by page or the whole chip, the option byte is not erased during
whole chip erase operation.
The flash should be program by page (256 byte), byte program operation is not supported.
The flash page should be erased before program, it is not recommend to program the same
page multiple times without erase.

2.5.

Boot configuration
The WB32FQ95xx devices provide three kinds of boot sources which can be selected by the
BOOT0 and BOOT1 pins. The details are shown in the following table. The value on the two
pins is latched on the 4th rising edge of system clock after a reset. It is up to the user to set
the BOOT0 and BOOT1 pins after a power-on reset or a system reset to select the required
boot source. Once the two pins have been sampled, they are free and can be used for other
purposes.

Doc ID 2905025

Rev01

34

WB32FQ95xx Reference Manual

Table 2-3. Boot modes
Boot mode selection pins
Selected boot source
Boot1

Boot0

Main Flash Memory

x

0

Boot loader

0

1

On-chip SRAM

1

1

Note: When the boot source is hoped to be set as “Main Flash Memory”, the Boot0 pin has to
be connected with GND definitely and can not be floating.
After power-on sequence or a system reset, the ARM® Cortex™-M3 processor fetches the
top-of-stack value from address 0x0000_0000 and the base address of boot code from
0x0000_0004 in sequence. Then, it starts executing code from the base address of boot
code.
Due to the selected boot source, either the main flash memory (original memory space
beginning at 0x0800_0000) or the system memory (original memory space beginning at
0x1FFF_E000) is aliased in the boot memory space which begins at the address
0x0000_0000. When the on-chip SRAM whose memory space is beginning at 0x2000_0000
is selected as the boot source, in the application initialization code, you have to relocate the
vector table in SRAM using the NVIC exception table and offset register.
The embedded boot loader is located in the System memory, which is used to reprogram the
Flash memory. In WB32FQ95xx devices, the boot loader can be activated through the UART
interface.

2.6.

CACHE register

2.6.1.

Cache Control register (CACHE_CR)
Address offset: 0x00
Reset value: 0x0300 0000

Bits

Fields

R/W

31:26

Reserved

-

Descriptions
Must be kept at reset value
CACHE Enable control

25:24

CHEEN

RW

0x0：the cache is disabled
0x3：the cache is enabled

Doc ID 2905025

Rev01

35

WB32FQ95xx Reference Manual

Bits

Fields

R/W

23:9

Reserved

-

Descriptions
Must be kept at reset value
High speed access auxiliary function, must be enabled when system

8

HIFREQ

RW

frequency is higher than 96Mhz.
0: high speed access auxiliary function is turned off
1: high speed access auxiliary function is turned on

7:6

Reserved

-

Must be kept at the reset value
Pre-fetch function control.

5:4

PREFEN

RW

0x0: the instruction prefetch function is turned off
0x3: the instruction prefetch function is turned on
Flash access wait cycle
0x0: 0 wait cycle, when

system frequency ≤ 32Mhz

0x1: 1 wait cycle, when 32Mhz < system frequency ≤ 48Mhz
3:0

LATENCY

RW

0x2: 2 wait cycle, when 48Mhz < system frequency ≤ 72Mhz
0x3: 3 wait cycle, when 72Mhz < system frequency ≤ 96Mhz
0x4: 4 wait cycle, when 96Mhz < system frequency ≤ 128Mhz
Others: Reserved

Doc ID 2905025

Rev01

36

