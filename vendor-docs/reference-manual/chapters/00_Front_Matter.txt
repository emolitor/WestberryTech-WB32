WB32FQ95xx Reference Manual

WB32FQ95xx
ARM@ 32-bit Corex-M3 MCU

Reference Manual
Preliminary
2021.12

Doc ID 2905025

Rev01

WB32FQ95xx Reference Manual

Table of Contents
Table of Contents.......................................................................................................................................... 2
List of Figures .............................................................................................................................................18
List of Tables ...............................................................................................................................................23
1. Documentation conventions .....................................................................................................................25
1.1. List of abbreviations for registers ...................................................................................................25
1.2. Peripheral availability .....................................................................................................................25
2. System and memory architecture .............................................................................................................26
2.1. ARM Cortex-M3 processor .............................................................................................................26
2.2. System architecture ........................................................................................................................27
2.3. Memory map ..................................................................................................................................29
2.3.1. Bit-banding ...........................................................................................................................32
2.3.2. On-chip SRAM memory .......................................................................................................33
2.3.3. On-chip flash memory overview ...........................................................................................33
2.4. Program and Erase ........................................................................................................................34
2.5. Boot configuration ..........................................................................................................................34
2.6. CACHE register ..............................................................................................................................35
2.6.1. Cache Control register (CACHE_CR) ..................................................................................35
3. System configuration (SYS) .....................................................................................................................37
3.1. Overview.........................................................................................................................................37
3.2. Main features of SYS .....................................................................................................................37
3.2.1. Security level configuration ..................................................................................................37
3.2.2. Information block write protection ........................................................................................38
3.2.3. The write protection of system memory space ....................................................................38
3.2.4. User program space write protection control .......................................................................38
3.2.5. Secondary Development ......................................................................................................40
3.3. SYS Register Description ...............................................................................................................41
3.3.1. ID Register (SYS_ID) ...........................................................................................................41
3.3.2. Memory control Register (SYS_MEMSZ) ............................................................................41
3.3.3. Security control Register (SYS_BTCR) ...............................................................................42
3.3.4. FLASH write protection register (SYS_MEMWEN) .............................................................42
3.3.5. Secondary development control Register (SYS_SENDEV) ................................................42
3.3.6. Reboot control Register (SYS_RSTCR) ..............................................................................43
3.3.7. Information block 4 protection register (SYS_IF4LCK) ........................................................43
3.3.8. Information block 5 protection register (SYS_IF5LCK) ........................................................44
3.3.9. Information block 6 protection register (SYS_IF6LCK) ........................................................44
3.3.10. Information block 7 protection register (SYS_IF7LCK) ......................................................44
3.3.11. Boot control Register (SYS_BTSR) ...................................................................................45
4. Cyclic Redundancy Check (CRC) ............................................................................................................46
4.1. CRC introduction ............................................................................................................................46
4.2. CRC main features .........................................................................................................................46
4.3. CRC register description ................................................................................................................46

Doc ID 2905025

Rev01

2

WB32FQ95xx Reference Manual

4.3.1. CRC mode register (CRC_MODE) ......................................................................................46
4.3.2. CRC seed register (CRC_SEED) ........................................................................................47
4.3.3. CRC checksum register (CRC_SUM) ..................................................................................47
4.3.4. CRC data register (CRC_WDATA).......................................................................................48
5. Power control (PWR) ................................................................................................................................49
5.1. Power supplies ...............................................................................................................................49
5.1.1. Independent A/D converter supply and reference voltage ...................................................49
5.1.2. Battery backup domain ........................................................................................................50
5.1.3. Voltage regulator ..................................................................................................................50
5.2. Power supply supervisor ................................................................................................................51
5.2.1. Power on reset (POR)/power down reset (PDR) .................................................................51
5.2.2. Programmable voltage detector ...........................................................................................51
5.3. Low-power modes ..........................................................................................................................52
5.3.1. Slowing down system clocks ...............................................................................................53
5.3.2. Peripheral clock gating .........................................................................................................53
5.3.3. Sleep mode ..........................................................................................................................53
5.3.4. Stop mode ............................................................................................................................55
5.3.5. Standby mode ......................................................................................................................57
5.3.6. Module status in low power mode ........................................................................................58
5.3.7. Auto-wakeup (AWU) from low-power mode .........................................................................59
5.4. Power control registers ...................................................................................................................59
5.4.1. Power control register 0 (PWR_CR0) ..................................................................................59
5.4.2. Control register 1 (PWR_CR1) ............................................................................................62
5.4.3. Control register 2 (PWR_CR2) ............................................................................................62
5.4.4. Status register 0 (PWR_SR0) ..............................................................................................62
5.4.5. Status register 1 (PWR_SR1) ..............................................................................................63
5.4.6. General purpose register 0 (PWR_GPREG0) .....................................................................64
5.4.7. General purpose register 1 (PWR_GPREG1) .....................................................................64
5.4.8. Configuration register (PWR_CFGR)...................................................................................64
5.4.9. Analog enable register 1 (PWR_ANAKEY 1) .......................................................................64
5.4.10. Analog enable register 2 (PWR_ANAKEY 2) .....................................................................65
6. Backup registers (BKP) ............................................................................................................................66
6.1. Overview.........................................................................................................................................66
6.2. Characteristics ................................................................................................................................66
6.3. Function overview ..........................................................................................................................66
6.3.1. RTC clock calibration ...........................................................................................................66
6.3.2. RTC clock calibration ...........................................................................................................67
6.4. Register description ........................................................................................................................67
6.4.1. RTC signal output control register (BKP_RTCCR) ..............................................................67
6.4.2. Tamper pin control register (BKP_CR) .................................................................................68
6.4.3. Tamper control and status register (BKP_CSR) ..................................................................68
6.4.4. Backup data register x (BKP_DATAx) (x= 0..21) .................................................................69
6.4.5. Backup domain control register (BKP_BDCR) ....................................................................69
7. Reset and Clock Control (RCC) ...............................................................................................................71
Doc ID 2905025

Rev01

3

WB32FQ95xx Reference Manual

7.1. Reset ..............................................................................................................................................71
7.1.1. System reset ........................................................................................................................71
7.1.2. Power source reset ..............................................................................................................71
7.1.3. Battery domain reset ............................................................................................................72
7.2. Clock...............................................................................................................................................72
7.2.1. System clock source ............................................................................................................72
7.2.2. Sub-clock source ..................................................................................................................72
7.2.3. Clock tree .............................................................................................................................72
7.2.4. HSE clock .............................................................................................................................73
7.2.5. HSI clock ..............................................................................................................................74
7.2.6. PLL clock ..............................................................................................................................74
7.2.7. LSE clock .............................................................................................................................74
7.2.8. LSI clock ...............................................................................................................................74
7.2.9. System clock MAINCLK selection ........................................................................................75
7.2.10. Clock Security System CSS ...............................................................................................75
7.2.11. RTC clock ...........................................................................................................................75
7.2.12. IWDG clock ........................................................................................................................76
7.2.13. Clock-out capability ............................................................................................................76
7.2.14. Bus clock switch and divider ..............................................................................................76
7.3. RCC registers .................................................................................................................................76
7.3.1. PLL pre-divider control register (RCC_PLLPRE) .................................................................76
7.3.2. PLL clock source selection register (RCC_PLLSRC) ..........................................................77
7.3.3. System clock source selection register (RCC_MAINCLKSRC) ...........................................77
7.3.4. System clock source update enable register (RCC_MAINCLKUEN) ..................................77
7.3.5. USB clock pre-divider control register (RCC_USBPRE) .....................................................78
7.3.6. AHB clock pre-divider register (RCC_AHBPRE) .................................................................78
7.3.7. APB1 clock pre-divider control register (RCC_APB1PRE) ..................................................79
7.3.8. APB2 clock pre-divider control register (RCC_APB2PRE) ..................................................79
7.3.9. USB FIFO clock source selection register (RCC_USBFIFOCLKSRC) ...............................80
7.3.10. Clock output selection register (RCC_MCOSEL) ..............................................................80
7.3.11. AHB peripherals clock enable register0 (RCC_AHBENR0) ...............................................80
7.3.12. AHB peripherals clock enable register1 (RCC_AHBENR1)...............................................81
7.3.13. AHB peripherals clock enable register2 (RCC_AHBENR2)...............................................81
7.3.14. APB1 peripherals clock enable register (RCC_APB1ENR) ...............................................82
7.3.15. APB2 peripherals clock enable register (RCC_APB2ENR) ...............................................82
7.3.16. IWDG clock enable register (RCC_IWDGCLKENR) .........................................................83
7.3.17. USB48MHz clock enable register (RCC_USBCLKENR) ...................................................83
7.3.18. SPIS1 clock enable register (RCC_SPIS1CLKENR) .........................................................84
7.3.19. SPIS2 clock enable register (RCC_SPIS2CLKENR) .........................................................84
7.3.20. USB FIFO clock enable register (RCC_USBFIFOCLKENR) .............................................84
7.3.21. AHB peripheral reset register1 (RCC_AHBRSTR1) ..........................................................84
7.3.22. APB1 peripheral reset register(RCC_APB1RSTR) ............................................................85
7.3.23. APB2 peripheral reset register (RCC_APB2RSTR) ...........................................................86
7.3.24. Reset flag clear register (RCC_CLRRSTSTAT) .................................................................86
Doc ID 2905025

Rev01

4

WB32FQ95xx Reference Manual

7.3.25. Battery domain reset register (RCC_BDRSTR) .................................................................87
7.3.26. LSI battery domain clock enable register (RCC_LSI2RTCENR) .......................................87
7.3.27. HSE clock 128-divider enable register (RCC_HSE2RTCENR) .........................................87
7.3.28. Reset flag register (RCC_RSTSTAT) .................................................................................87
8. General-purpose and alternate-function I/Os (GPIOs and AFIOs) ...........................................................89
8.1. Introduction .....................................................................................................................................89
8.2. GPIO main features ........................................................................................................................89
8.3. GPIO functional description ...........................................................................................................89
8.3.1. General-purpose I/O (GPIO) ................................................................................................91
8.3.2. I/O pin alternate function multiplexer and mapping .............................................................91
8.3.3. I/O port control registers ......................................................................................................93
8.3.4. I/O port data registers ..........................................................................................................93
8.3.5. I/O data bit handling .............................................................................................................93
8.3.6. GPIO locking mechanism ....................................................................................................94
8.3.7. I/O alternate function input/output ........................................................................................94
8.3.8. External interrupt/wakeup lines ............................................................................................96
8.3.9. Input configuration ................................................................................................................97
8.3.10. Output configuration ...........................................................................................................97
8.3.11. Alternate function configuration ..........................................................................................97
8.3.12. Analog configuration...........................................................................................................98
8.3.13. Using the HSE or LSE oscillator pins as GPIOs ................................................................98
8.3.14. Using the GPIO pins in the backup supply domain ...........................................................98
8.4. GPIO registers ................................................................................................................................99
8.4.1. GPIO port mode register（GPIOx_MODER） ....................................................................99
8.4.2. GPIO port output type register（GPIOx_OTYPER） ..........................................................99
8.4.3. GPIO port output speed register（GPIOx_OSPEEDR） ....................................................99
8.4.4. GPIO port pull-up/pull-down register（GPIOx_PUPDR） .................................................100
8.4.5. GPIO port input data register（GPIOx_IDR） ...................................................................100
8.4.6. GPIO port output data register（GPIOx_ODR） ...............................................................100
8.4.7. GPIO port bit set/reset register （GPIOx_BSRR） ..........................................................101
8.4.8. GPIO port configuration lock register（GPIOx_LCKR） ...................................................101
8.4.9. GPIO alternate function low register（GPIOx_AFRL）.....................................................102
8.4.10. GPIO alternate function high register（GPIOx_AFRH）.................................................102
8.4.11. GPIO Port Schmitt Register（GPIOx_SMIT）.................................................................103
8.4.12. GPIO Port driver register（GPIOx_CURRENT) ..............................................................103
8.4.13. GPIO Port configuration auxiliary register（GPIOx_CFGMSK） ....................................104
8.5. AFIO registers ..............................................................................................................................104
8.5.1. External interrupt configuration register 1（AFIO_EXTICR1） .........................................104
8.5.2. External interrupt configuration register 2（AFIO_EXTICR2） .........................................104
8.5.3. External interrupt configuration register 3（AFIO_EXTICR3） .........................................105
8.5.4. External interrupt configuration register 4 （AFIO_EXTICR4） .......................................105
9. Nested vectored interrupt controller (NVIC) ...........................................................................................106
9.1. NVIC Features ..............................................................................................................................106
9.2. Interrupt and exception vectors ....................................................................................................106
Doc ID 2905025

Rev01

5

WB32FQ95xx Reference Manual

10. Interrupt/event controller (EXTI) ...........................................................................................................109
10.1. Overview ....................................................................................................................................109
10.2. Characteristics ............................................................................................................................109
10.3. External interrupt and event (EXTI) block diagram ....................................................................109
10.4. External Interrupt and Event function overview ......................................................................... 110
10.5. Register definition ....................................................................................................................... 111
10.5.1. Interrupt enable register (EXTI_INTEN)........................................................................... 111
10.5.2. Event enable register (EXTI_EMR) .................................................................................. 111
10.5.3. Rising edge trigger enable register (EXTI_RTSR) ........................................................... 111
10.5.4. Falling edge trigger enable register (EXTI_FTSR) .......................................................... 111
10.5.5. Software interrupt event register (EXTI_SWIER) ............................................................ 112
10.5.6. Pending register (EXTI_PR) ............................................................................................ 112
11. Analog control (ANCTL) ........................................................................................................................ 113
11.1. Analog control introduction ......................................................................................................... 113
11.2. Analog control major features ..................................................................................................... 113
11.3. Analog control function description ............................................................................................. 113
11.3.1. MHSI control ..................................................................................................................... 113
11.3.2. FHSI control ..................................................................................................................... 113
11.3.3. LSI control ........................................................................................................................ 113
11.3.4. HSE control ...................................................................................................................... 114
11.3.5. Phase locked loop (PLL) .................................................................................................. 114
11.3.6. PVD control ...................................................................................................................... 115
11.3.7. SARADC control ............................................................................................................... 115
11.3.8. CSS control ...................................................................................................................... 115
11.4. Register definition ....................................................................................................................... 116
11.4.1. BG control SFR2 (ANCTL_BGCR2) ................................................................................ 116
11.4.2. MHSI enable SFR (ANCTL_MHSIENR) .......................................................................... 116
11.4.3. MHSI Status SFR (ANCTL_MHSISR) .............................................................................. 116
11.4.4. FHSI enable SFR (ANCTL_FHSIENR) ............................................................................ 116
11.4.5. FHSI Status SFR (ANCTL_FHSISR) ............................................................................... 117
11.4.6. LSI enable SFR (ANCTL_LSIENR) .................................................................................. 117
11.4.7. LSI Status SFR (ANCTL_LSISR) ..................................................................................... 117
11.4.8. HSE control SFR 0 (ANCTL_HSECR0) ........................................................................... 117
11.4.9. HSE control SFR 1 (ANCTL_HSECR1) ........................................................................... 118
11.4.10. HSE Status SFR (ANCTL_HSESR) ............................................................................... 118
11.4.11. PLL control SFR (ANCTL_PLLCR) ................................................................................ 118
11.4.12. PLL enable SFR (ANCTL_PLLENR) .............................................................................. 118
11.4.13. PLL Status SFR (ANCTL_PLLSR) ................................................................................. 119
11.4.14. PVD control SFR (ANCTL_PVDCR) .............................................................................. 119
11.4.15. PVD enable SFR (ANCTL_PVDENR) ............................................................................ 119
11.4.16. SARADC enable SFR (ANCTL_SARENR) .................................................................... 119
11.4.17. POR control SFR (ANCTL_PORCR) .............................................................................120
11.4.18. INT Status SFR (ANCTL_ISR) .......................................................................................120
11.4.19. INT enable SFR (ANCTL_IER) ......................................................................................120
Doc ID 2905025

Rev01

6

WB32FQ95xx Reference Manual

11.4.20. INT clear SFR (ANCTL_ICR) .........................................................................................121
11.4.21. CSS enable SFR (ANCTL_CSSENR) ............................................................................121
11.4.22. CSS configuration SFR (ANCTL_CSSCR) ....................................................................121
12. Special Function Macro (SFM) .............................................................................................................123
12.1. SFM Introduction ........................................................................................................................123
12.1.1. SFM main features ...........................................................................................................123
12.2. Function description ...................................................................................................................123
12.2.1. Count the number of “1” ...................................................................................................123
12.2.2. Expand all the bits in a WORD (32bit) .............................................................................123
12.2.3. USB port status detection and interrupt control ...............................................................123
12.3. Register definition .......................................................................................................................123
12.3.1. Control register(SFM_CTRL) ...........................................................................................123
12.3.2. SFM Data register (SFM_DATA) ......................................................................................124
12.3.3. SFM Result register (SFM_DOUTx, x=0-7) .....................................................................124
12.3.4. USB port status detection control/status register (SFM_USBPSDCSR) .........................124
12.3.5. USB Port status register (SFM_USBPSTAT) ...................................................................125
13. Direct Memory access Controller (DMAC) ...........................................................................................126
13.1. Overview ....................................................................................................................................126
13.2. Characteristics ............................................................................................................................126
13.3. Pre-Configuration .......................................................................................................................127
13.4. Block Diagram ............................................................................................................................127
13.5. Function Overview ......................................................................................................................128
13.5.1. DMA operation .................................................................................................................128
13.5.2. Arbitration for AHB master interface .................................................................................128
13.5.3. DMA Handshaking ...........................................................................................................129
13.5.4. Scatter ..............................................................................................................................131
13.5.5. Gather ..............................................................................................................................131
13.5.6. AHB Transfer Error Handling ...........................................................................................132
13.5.7. Disabling a Channel Prior to Transfer Completion ...........................................................133
13.5.8. Programming Examples ...................................................................................................133
13.5.9. Interrupt ............................................................................................................................134
13.5.10. DMA Request Mapping ..................................................................................................135
13.6. DMA Registers ...........................................................................................................................136
13.6.1. Source Address for Channel x: SARx (x=0,1,2)...............................................................136
13.6.2. Destination Address for Channel x: DARx (x=0,1,2) ........................................................137
13.6.3. Channel Control register Low: CTLLx (x=0,1,2) ..............................................................137
13.6.4. Channel Control register High: CTLHx (x=0,1,2) .............................................................139
13.6.5. Channel Configuration register Low: CFGLx (x=0,1,2) ....................................................140
13.6.6. Channel Configuration register High: CFGHx (x=0,1,2) ..................................................141
13.6.7. Source Gather Register: SGRx (x=0,1,2) ........................................................................142
13.6.8. Destination Scatter Register: DSRx (x=0,1,2) .................................................................142
13.6.9. Interrupt Raw Status Register: .........................................................................................142
13.6.10. Interrupt Status Register ................................................................................................143
13.6.11. Interrupt Mask Register ..................................................................................................143
Doc ID 2905025

Rev01

7

WB32FQ95xx Reference Manual

13.6.12. Interrupt Clear Register ..................................................................................................144
13.6.13. Status for each Interrupt type: StatusInt ........................................................................145
13.6.14. Source Software Transaction Request register: ReqSrcReg ........................................145
13.6.15. Destination Software Transaction Request register: ReqDstReg ..................................146
13.6.16. Source Single Transaction Request register: SglRqSrcReg .........................................147
13.6.17. Destination Single Transaction Request register: SglRqDstReg ...................................148
13.6.18. Source Last Transaction Request register: LstSrcReg ..................................................148
13.6.19. Destination Last Transaction Request register: LstDstReg ...........................................149
13.6.20. DMA Configuration Register: DmaCfgReg ....................................................................150
13.6.21. Channel Enable register: ChEnReg ...............................................................................150
13.6.22. DMA ID register0: DmaCompsID0 .................................................................................151
13.6.23. DMA ID register1: DmaCompsID1 .................................................................................151
14. Analog to digital conversion (ADC) .......................................................................................................152
14.1. ADC introduction ........................................................................................................................152
14.2. ADC main features .....................................................................................................................152
14.3. ADC functional description .........................................................................................................152
14.3.1. ADC on-off control ............................................................................................................153
14.3.2. ADC clock .........................................................................................................................153
14.3.3. ADC resolution .................................................................................................................153
14.3.4. Channel selection.............................................................................................................154
14.3.5. Single conversion mode ...................................................................................................154
14.3.6. Continuous conversion mode ..........................................................................................155
14.3.7. Timing diagram .................................................................................................................155
14.3.8. Analog watchdog ..............................................................................................................155
14.3.9. Scan mode .......................................................................................................................156
14.3.10. Injected channel management .......................................................................................157
14.3.11. Discontinuous mode .......................................................................................................157
14.4. Calibration ..................................................................................................................................158
14.5. Data alignment ...........................................................................................................................159
14.6. Channel-by-channel programmable sample time ......................................................................159
14.7. Conversion on external trigger ...................................................................................................160
14.8. DMA request ...............................................................................................................................160
14.9. Temperature sensor ...................................................................................................................161
14.10. ADC interrupts ..........................................................................................................................161
14.11. ADC registers ...........................................................................................................................162
14.11.1. ADC status register (ADC_SR) ......................................................................................162
14.11.2. ADC control register 1(ADC_CR1) .................................................................................163
14.11.3. ADC control register 2(ADC_CR2) .................................................................................165
14.11.4. ADC sample time register 1(ADC_SMPR1) ...................................................................167
14.11.5. ADC sample time register2(ADC_SMPR2) ....................................................................168
14.11.6. ADC injected channel data offset register x (ADC_JOFRx）(x =1..4) ...........................168
14.11.7. ADC watchdog high threshold register (ADC_HTR) ......................................................168
14.11.8. ADC watchdog low threshold register (ADC_LTR).........................................................169
14.11.9. ADC regular sequence register 1 (ADC_SQR1) ............................................................169
Doc ID 2905025

Rev01

8

WB32FQ95xx Reference Manual

14.11.10. ADC regular sequence register 2 (ADC_SQR2) ..........................................................169
14.11.11. ADC regular sequence register 3 (ADC_SQR3) ..........................................................170
14.11.12. ADC injected sequence register (0ADC_JSQR) ..........................................................170
14.11.13. ADC injected data register x (ADC_JDRx) (x=1..4) .....................................................171
14.11.14. ADC regular data register (ADC_DR) ..........................................................................171
14.11.15. ADC control register 3(ADC_CR3) ...............................................................................171
14.11.16. ADC injected convertion DMA register (ADC_JDMAR) ...............................................172
15. Advanced timer (TIM1) .........................................................................................................................173
15.1. Overview ....................................................................................................................................173
15.2. Characteristics ............................................................................................................................173
15.3. Block diagram .............................................................................................................................174
15.4. Function overview ......................................................................................................................175
15.4.1. Clock selection .................................................................................................................175
15.4.2. Prescaler ..........................................................................................................................176
15.4.3. Up counting mode ............................................................................................................176
15.4.4. Down counting mode .......................................................................................................178
15.4.5. Center-aligned counting mode .........................................................................................180
15.4.6. Counter repetition.............................................................................................................183
15.4.7. Capture/compare channels ..............................................................................................184
15.4.8. PWM mode ......................................................................................................................186
15.4.9. Channel output reference signal ......................................................................................187
15.4.10. Outputs complementary .................................................................................................187
15.4.11. Dead time insertion ........................................................................................................188
15.4.12. Break function ................................................................................................................189
15.4.13. Quadrature decoder .......................................................................................................190
15.4.14. Hall sensor function........................................................................................................191
15.4.15. Single pulse mode..........................................................................................................193
15.4.16. Timers interconnection ...................................................................................................193
15.4.17. Timer DMA mode ...........................................................................................................198
15.4.18. Timer debug mode .........................................................................................................198
15.5. Register definition .......................................................................................................................198
15.5.1. Control register 1 (TIMx_CR1) .........................................................................................198
15.5.2. Control register 2 (TIMx_CR2) .........................................................................................199
15.5.3. Slave mode configuration register (TIMx_SMCR) ...........................................................200
15.5.4. DMA and interrupt enable register (TIMx_DIER) .............................................................202
15.5.5. Interrupt flag register (TIMx_SR) .....................................................................................203
15.5.6. Software event generation register (TIMx_EGR) .............................................................204
15.5.7. Channel control register 0 (TIMx_CCMR1)......................................................................205
15.5.8. Channel control register 1 (TIMx_CCMR2)......................................................................208
15.5.9. Channel control register 2 (TIMx_CCER) ........................................................................210
15.5.10. Counter register (TIMx_CNT) ........................................................................................ 211
15.5.11. Prescaler register (TIMx_PSC) ...................................................................................... 211
15.5.12. Counter auto reload register (TIMx_ARR) .....................................................................212
15.5.13. Counter repetition register (TIMx_RCR) ........................................................................212
Doc ID 2905025

Rev01

9

WB32FQ95xx Reference Manual

15.5.14. Channel 1 capture/compare value register (TIMx_CCR1).............................................212
15.5.15. Channel 2 capture/compare value register (TIMx_CCR2).............................................212
15.5.16. Channel 3 capture/compare value register (TIMx_CCR3).............................................213
15.5.17. Channel 4 capture/compare value register (TIMx_CCR4).............................................213
15.5.18. Complementary channel protection register (TIMx_BDTR) ...........................................213
16. General-Purpose Timers (TIM2-TIM4) .................................................................................................216
16.1. Overview ....................................................................................................................................216
16.2. Characteristics ............................................................................................................................216
16.3. Block diagram .............................................................................................................................217
16.4. Function overview ......................................................................................................................217
16.4.1. Clock selection .................................................................................................................217
16.4.2. Prescaler ..........................................................................................................................219
16.4.3. Up counting mode ............................................................................................................219
16.4.4. Down counting mode .......................................................................................................221
16.4.5. Center-aligned counting mode .........................................................................................223
16.4.6. Capture/compare channels ..............................................................................................226
16.4.7. PWM mode ......................................................................................................................228
16.4.8. Channel output reference signal ......................................................................................229
16.4.9. Quadrature decoder .........................................................................................................230
16.4.10. Hall sensor function........................................................................................................231
16.4.11. Single pulse mode ..........................................................................................................233
16.4.12. Timers interconnection ...................................................................................................233
16.4.13. Timer DMA mode ...........................................................................................................233
16.4.14. Timer debug mode .........................................................................................................234
16.5. Register definition .......................................................................................................................234
16.5.1. Control register 1 (TIMx_CR1) .........................................................................................234
16.5.2. Control register 2 (TIMx_CR2) .........................................................................................235
16.5.3. Slave mode configuration register (TIMx_SMCR) ...........................................................236
16.5.4. DMA and interrupt enable register (TIMx_DIER) .............................................................237
16.5.5. Interrupt flag register (TIMx_SR) .....................................................................................238
16.5.6. Software event generation register (TIMx_EGR).............................................................239
16.5.7. Channel control register 0 (TIMx_CCMR1)......................................................................240
16.5.8. Channel control register 1 (TIMx_CCMR2)......................................................................242
16.5.9. Channel control register 2 (TIMx_CCER) ........................................................................245
16.5.10. Counter register (TIMx_CNT) ........................................................................................246
16.5.11. Prescaler register (TIMx_PSC) ......................................................................................246
16.5.12. Counter auto reload register (TIMx_ARR) .....................................................................246
16.5.13. Channel 1 capture/compare value register (TIMx_CCR1).............................................246
16.5.14. Channel 2 capture/compare value register (TIMx_CCR2).............................................247
16.5.15. Channel 3 capture/compare value register (TIMx_CCR3).............................................247
16.5.16. Channel 4 capture/compare value register (TIMx_CCR4).............................................247
17. Real-time Clock (RTC) .........................................................................................................................249
17.1. Overview ....................................................................................................................................249
17.2. Characteristics ............................................................................................................................249
Doc ID 2905025

Rev01

10

WB32FQ95xx Reference Manual

17.3. Function overview ......................................................................................................................249
17.3.1. RTC reset .........................................................................................................................250
17.3.2. RTC reading .....................................................................................................................250
17.3.3. RTC configuration ............................................................................................................251
17.3.4. RTC flag assertion ...........................................................................................................251
17.4. Register definition .......................................................................................................................252
17.4.1. RTC interrupt enable register (RTC_CRH) ......................................................................252
17.4.2. RTC control register (RTC_CRL) .....................................................................................252
17.4.3. RTC prescaler high register (RTC_PRLH) .......................................................................253
17.4.4. RTC prescaler low register (RTC_PRLL) .........................................................................253
17.4.5. RTC divider high register (RTC_DIVH) ............................................................................253
17.4.6. RTC divider low register (RTC_DIVL) ..............................................................................253
17.4.7. RTC counter high register (RTC_CNTH) .........................................................................254
17.4.8. RTC counter low register (RTC_CNTL) ...........................................................................254
17.4.9. RTC alarm high register (RTC_ALRH) ............................................................................254
17.4.10. RTC alarm low register (RTC_ALRL) ............................................................................254
18. Watchdog timer (IWDG) .......................................................................................................................255
18.1. Overview ....................................................................................................................................255
18.2. Characteristics ............................................................................................................................255
18.3. Function overview ......................................................................................................................255
18.4. Register definition.......................................................................................................................256
18.4.1. Control register (IWDG_KR) ............................................................................................256
18.4.2. Prescaler register (IWDG_PR) .........................................................................................256
18.4.3. Reload register (IWDG_RLR) ..........................................................................................257
18.4.4. Status register (IWDG_SR) ..............................................................................................257
19. Window watchdog timer (WWDG) ........................................................................................................258
19.1. Overview ....................................................................................................................................258
19.2. Characteristics ............................................................................................................................258
19.3. Function overview ......................................................................................................................258
19.4. Register definition .......................................................................................................................260
19.4.1. Control register (WWDG_CR) ..........................................................................................260
19.4.2. Configuration register (WWDG_CFR)..............................................................................260
19.4.3. Status register (WWDG_SR) ...........................................................................................260
20. Flash controller (FMC) ..........................................................................................................................261
20.1. Flash controller overview............................................................................................................261
20.2. Major features of flash controller ................................................................................................261
20.3. Function description ...................................................................................................................261
20.3.1. Write Operation ................................................................................................................261
20.3.2. CRC calculation ...............................................................................................................262
20.4. Register definition .......................................................................................................................262
20.4.1. CRC control register (FMC_CRCON) ..............................................................................262
20.4.2. Address register (FMC_ADDR) ........................................................................................263
20.4.3. Data register (FMC_DATA1) ............................................................................................263
20.4.4. Cache register (FMC_BUFx) x=0...63 .............................................................................263
Doc ID 2905025

Rev01

11

WB32FQ95xx Reference Manual

21. USB FULL SPEED DEVICE (USB) ......................................................................................................264
21.1. USB introduction ........................................................................................................................264
21.2. USB main features .....................................................................................................................264
21.3. USB FIFO ...................................................................................................................................264
21.4. Programming Scheme................................................................................................................264
21.4.1. USB Interrupt Handling ....................................................................................................264
21.5. USB Reset ..................................................................................................................................265
21.6. Suspend/Resume .......................................................................................................................266
21.6.1. USB modules active during suspend ...............................................................................266
21.6.2. USB modules inactive during suspend ............................................................................266
21.6.3. Remote wake up ..............................................................................................................266
21.7. Endpoint 0 Handling ...................................................................................................................266
21.7.1. Zero Data Requests .........................................................................................................267
21.7.2. Write Requests .................................................................................................................267
21.7.3. Read Requests ................................................................................................................268
21.7.4. Endpoint 0 states .............................................................................................................269
21.7.5. Endpoint 0 Service Routine .............................................................................................270
21.7.6. Error Handling ..................................................................................................................274
21.8. Bulk IN Endpoint .........................................................................................................................275
21.8.1. Setup Enpoint ...................................................................................................................275
21.8.2. Enpoint Operation ............................................................................................................276
21.8.3. Error Handling ..................................................................................................................276
21.9. Bulk OUT Endpoint .....................................................................................................................276
21.9.1. Setup Enpoint ...................................................................................................................277
21.9.2. Enpoint Operation ............................................................................................................277
21.9.3. Error Handling ..................................................................................................................277
21.10. Interrupt In Endpoint .................................................................................................................278
21.11. Interrupt Out Endpoint ..............................................................................................................278
21.12. Isochronous IN Endpoint ..........................................................................................................278
21.12.1. Setup Endpoint...............................................................................................................279
21.12.2. Enpoint Operation ..........................................................................................................279
21.12.3. Error Handling ................................................................................................................280
21.13. Isochronous OUT Endpoint ......................................................................................................280
21.13.1. Setup Enpoint.................................................................................................................280
21.13.2. Enpoint Operation ..........................................................................................................280
21.13.3. Error Handling ................................................................................................................281
21.14. USB Registers ..........................................................................................................................281
21.14.1. USB Interrupt Registers .................................................................................................282
21.14.2. USB common register ....................................................................................................285
21.14.3. USB Frame Number Registers ......................................................................................286
22. Serial peripheral interface (SPI) ...........................................................................................................291
22.1. Introduction .................................................................................................................................291
22.2. SPI features ................................................................................................................................291
22.3. Clock mode ................................................................................................................................292
Doc ID 2905025

Rev01

12

WB32FQ95xx Reference Manual

22.4. Transfer Modes ..........................................................................................................................293
22.5. SPI slave mode ..........................................................................................................................293
22.6. SPI master mode ........................................................................................................................295
22.7. DMA transmission ......................................................................................................................299
22.8. Interrupts ....................................................................................................................................299
22.9. SPI Slave mode register.............................................................................................................299
22.9.1. SPI Control register 0(SPI_CR0) .....................................................................................299
22.9.2. SPI Enable register (SPI_SPIENR) .................................................................................300
22.9.3. MICROWIRE Control register (SPI_MWCR) ...................................................................301
22.9.4. TX FIFO threshold register (SPI_TXFTLR)......................................................................301
22.9.5. Receive FIFO threshold register (SPI_RXFTLR) .............................................................301
22.9.6. TX FIFO status register (SPI_TXFLR) .............................................................................301
22.9.7. Receive FIFO status register (SPI_RXFLR) ....................................................................302
22.9.8. SPI Status register (SPI_SR) ...........................................................................................302
22.9.9. Interrupt enable register (SPI_IER) ..................................................................................302
22.9.10. Interrupt status register (SPI_ISR) .................................................................................302
22.9.11. Raw interrupt status register (SPI_RISR) ......................................................................303
22.9.12. Transmit Overflow interrupt clear register (SPI_TXOICR) .............................................303
22.9.13. Receive Overflow interrupt clear register (SPI_RXOICR) .............................................303
22.9.14. Receive underflow interrupt clear register (SPI_RXUICR) ............................................304
22.9.15. Interrupt clear register (SPI_ICR) ..................................................................................304
22.9.16. DMA ENABLE register (SPI_DMACR)...........................................................................304
22.9.17. DMA TX threshold register (SPI_DMATDLR) ................................................................305
22.9.18. DMA RX threshold register (SPI_DMARDLR) ...............................................................305
22.9.19. SPI Data register (SPI_DR) ...........................................................................................305
22.10. SPI master mode register ........................................................................................................305
22.10.1. SPI Control register0 (SPI_CR0) ...................................................................................305
22.10.2. SPI Control Register 1(SPI_CR1) ..................................................................................306
22.10.3. SPI Enable Register (SPI_SPIENR) ..............................................................................306
22.10.4. MICROWIRE Control Register (SPI_MWCR) ................................................................307
22.10.5. Slave Select Register (SPI_SER) ..................................................................................307
22.10.6. Baud Rate Register (SPI_BAUDR) ................................................................................307
22.10.7. TX FIFO Threshold Register (SPI_TXFTLR) .................................................................308
22.10.8. RX FIFO Threshold Register (SPI_RXFTLR) ................................................................308
22.10.9. TX FIFO Status Register (SPI_TXFLR) .........................................................................308
22.10.10. RX FIFO Status Register (SPI_RXFLR) ......................................................................308
22.10.11. SPI Status Register (SPI_SR) ......................................................................................309
22.10.12. Interrupt enable register (SPI_IER)..............................................................................309
22.10.13. Interrupt status register (SPI_ISR) ...............................................................................309
22.10.14. Raw interrupt status register (SPI_RISR) ....................................................................310
22.10.15. Overflow interrupt clear register (SPI_TXOICR) ..........................................................310
22.10.16. RX Overflow interrupt clear register (SPI_RXOICR) ...................................................310
22.10.17. RX underflow interrupt clear register (SPI_RXUICR) ..................................................310
22.10.18. Interrupt clear register (SPI_ICR) ................................................................................ 311
Doc ID 2905025

Rev01

13

WB32FQ95xx Reference Manual

22.10.19. DMA Enable register (SPI_DMACR)............................................................................ 311
22.10.20. DMA TX threshold register (SPI_DMATDLR) .............................................................. 311
22.10.21. DMA RX threshold register (SPI_DMARDLR) ............................................................. 311
22.10.22. SPI Data register (SPI_DR) .........................................................................................312
23. 4-wire serial peripheral interface (QSPI) ..............................................................................................313
23.1. Introduction .................................................................................................................................313
23.2. QSPI features .............................................................................................................................313
23.3. Clock phase and clock polarity ...................................................................................................313
23.4. Transfer Modes ..........................................................................................................................314
23.5. QSPI Master Mode .....................................................................................................................314
23.6. DMA transmission ......................................................................................................................315
23.7. Interrupt ......................................................................................................................................315
23.8. QSPI Master Mode Register ......................................................................................................316
23.8.1. QSPI Control Register 0(QSPI_CR0) ..............................................................................316
23.8.2. QSPI Control register 1(QSPI_CR1) ................................................................................316
23.8.3. QSPI Enable register (QSPI_SPIENR) ...........................................................................317
23.8.4. Slave select register (QSPI_SER) ...................................................................................317
23.8.5. Baud rate register (QSPI_BAUDR) ..................................................................................317
23.8.6. TX FIFO threshold register (QSPI_TXFTLR) ...................................................................318
23.8.7. RX FIFO threshold register (QSPI_RXFTLR) ..................................................................318
23.8.8. TX FIFO status register (QSPI_TXFLR) ..........................................................................318
23.8.9. RX FIFO status register (QSPI_RXFLR) .........................................................................318
23.8.10. QSPI Status register (QSPI_SR) ...................................................................................318
23.8.11. Interrupt enable register (QSPI_IER) .............................................................................319
23.8.12. Interrupt status register (QSPI_ISR) ..............................................................................319
23.8.13. Raw interrupt status register (QSPI_RISR) ...................................................................319
23.8.14. TX overflow interrupt clear register (QSPI_TXOICR) ....................................................320
23.8.15. RX overflow interrupt clear register (QSPI_RXOICR) ...................................................320
23.8.16. Receive underflow interrupt clear register (QSPI_RXUICR) .........................................320
23.8.17. Interrupt clear register (QSPI_ICR)................................................................................321
23.8.18. DMA Enable register (QSPI_DMACR) ...........................................................................321
23.8.19. DMA TX threshold register (QSPI_DMATDLR) ..............................................................321
23.8.20. DMA RX threshold register (QSPI_DMARDLR) ............................................................321
23.8.21. QSPI Data register (QSPI_DR) ......................................................................................321
23.8.22. QSPI Enhanced mode configuration register (QSPI_ESPICR) .....................................322
24. Integrated Circuit Interface (I2C) ..........................................................................................................323
24.1. Overview ....................................................................................................................................323
24.2. Characteristics ............................................................................................................................323
24.3. I2C implementation ....................................................................................................................324
24.4. Block Diagram ............................................................................................................................324
24.5. Function Overview ......................................................................................................................324
24.5.1. Mode Selection ................................................................................................................324
24.5.2. Addressing Slave Protocol ...............................................................................................325
24.5.3. Transmitting and Receiving Protocol ...............................................................................327
Doc ID 2905025

Rev01

14

WB32FQ95xx Reference Manual

24.5.4. START BYTE Transfer Protocol .......................................................................................328
24.5.5. Multiple Master Arbitration ...............................................................................................328
24.5.6. Slave Mode Operation .....................................................................................................329
24.5.7. Master Mode Operation ...................................................................................................332
24.5.8. Disable I2C .......................................................................................................................333
24.5.9. Aborting I2C Transfers .....................................................................................................333
24.5.10. Spike Suppression .........................................................................................................333
24.6. I2C Bus Clear .............................................................................................................................334
24.7. Device ID ....................................................................................................................................335
24.8. SMBUS Protocol ........................................................................................................................335
24.9. SMBUS Address Resolution Protocol ........................................................................................336
24.10. SMBus Alert ..............................................................................................................................336
24.11. SDA Hold Time .........................................................................................................................336
24.12. IC_CLK Frequency Configuration ............................................................................................337
24.13. DMA interfaces .........................................................................................................................337
24.14. Interrupts ..................................................................................................................................337
24.15. I2C Registers ............................................................................................................................338
24.15.1. I2C_CON ........................................................................................................................338
24.15.2. I2C_TAR .........................................................................................................................339
24.15.3. I2C_SAR ........................................................................................................................340
24.15.4. I2C_HS_MADDR ...........................................................................................................341
24.15.5. I2C_DATA_CMD ............................................................................................................341
24.15.6. I2C_SS_SCL_HCNT ......................................................................................................342
24.15.7. I2C_SS_SCL_LCNT ......................................................................................................342
24.15.8. I2C_FS_SCL_HCNT ......................................................................................................343
24.15.9. I2C_FS_SCL_LCNT.......................................................................................................343
24.15.10. I2C_HS_SCL_HCNT ...................................................................................................343
24.15.11. I2C_HS_SCL_LCNT ....................................................................................................344
24.15.12. I2C_INTR_STAT ..........................................................................................................344
24.15.13. I2C_INTR_MASK .........................................................................................................345
24.15.14. I2C_RAW_INTR_STAT ................................................................................................346
24.15.15. I2C_RX_TL ..................................................................................................................348
24.15.16. I2C_TX_TL ...................................................................................................................349
24.15.17. I2C_CLR_INTR ............................................................................................................349
24.15.18. I2C_CLR_RX_UNDER ................................................................................................349
24.15.19. I2C_CLR_RX_OVER ...................................................................................................350
24.15.20. I2C_CLR_TX_OVER....................................................................................................350
24.15.21. I2C_CLR_RD_REQ .....................................................................................................350
24.15.22. I2C_CLR_TX_ABRT ....................................................................................................350
24.15.23. I2C_CLR_RX_DONE ...................................................................................................351
24.15.24. I2C_CLR_ACTIVITY ....................................................................................................351
24.15.25. I2C_CLR_STOP_DET .................................................................................................351
24.15.26. I2C_CLR_START_DET ................................................................................................352
24.15.27. I2C_CLR_GEN_CALL .................................................................................................352
Doc ID 2905025

Rev01

15

WB32FQ95xx Reference Manual

24.15.28. I2C_ENABLE ...............................................................................................................352
24.15.29. I2C_STATUS ................................................................................................................353
24.15.30. I2C_TXFLR ..................................................................................................................356
24.15.31. I2C_RXFLR ..................................................................................................................356
24.15.32. I2C_SDA_HOLD ..........................................................................................................357
24.15.33. I2C_TX_ABRT_SOURCE ............................................................................................357
24.15.34. I2C_SLV_DATA_NACK_ONLY ....................................................................................359
24.15.35. I2C_DMA_CR ..............................................................................................................359
24.15.36. I2C_DMA_TDLR ..........................................................................................................359
24.15.37. I2C_DMA_RDLR ..........................................................................................................360
24.15.38. I2C_SDA_SETUP ........................................................................................................360
24.15.39. I2C_ACK_GENERAL_CALL ........................................................................................361
24.15.40. I2C_ENABLE_STATUS ................................................................................................361
24.15.41. I2C_FS_SPKLEN .........................................................................................................362
24.15.42. I2C_HS_SPKLEN ........................................................................................................362
24.15.43. I2C_CLR_RESTART_DET ...........................................................................................362
24.15.44. I2C_SCL_STUCK_AT_LOW_TIMEOUT .....................................................................363
24.15.45. I2C_SDA_STUCK_AT_LOW_TIMEOUT .....................................................................363
24.15.46. I2C_CLR_SCL_STUCK_DET ......................................................................................363
24.15.47. SMBUS_CLK_LOW_SEXT ..........................................................................................363
24.15.48. SMBUS_CLK_LOW_MEXT .........................................................................................364
24.15.49. SMBUS_THIGH_MAX_BUS_IDLE_CNT ....................................................................364
24.15.50. SMBUS_INTR_STAT ...................................................................................................365
24.15.51. SMBUS_INTR_MASK ..................................................................................................365
24.15.52. SMBUS_RAW_INTR_STAT .........................................................................................366
24.15.53. CLR_SMBUS_INTR .....................................................................................................367
24.15.54. I2C_OPTIONAL_SAR ..................................................................................................368
24.15.55. SMBUS_UDID_LSB .....................................................................................................368
25. Universal asynchronous transceiver (UART) .......................................................................................369
25.1. Introduction .................................................................................................................................369
25.1.1. RS232 Serial communication protocol .............................................................................369
25.1.2. 9-bit data transmission .....................................................................................................369
25.1.3. Fractional baud rate .........................................................................................................369
25.1.4. IrDA SIR Agreement .........................................................................................................371
25.1.5. Automatic flow control ......................................................................................................371
25.1.6. DMA operation .................................................................................................................372
25.2. UART Register ...........................................................................................................................373
25.2.1. Receiver buffer register (UART_RBR) (When DLAB = 0) ...............................................373
25.2.2. Transmitter hold register (UART_THR) (when DLAB = 0) ...............................................373
25.2.3. Divisor latch LSB register (UART_DLL) (when DLAB = 1) ..............................................373
25.2.4. Divider latch MSB register (UART_DLH) (when DLAB = 1） ..........................................374
25.2.5. Interrupt enable register (UART_IER) (when DLAB = 0) .................................................374
25.2.6. Interrupt identification register (UART_IIR) ......................................................................375
Doc ID 2905025

Rev01

16

WB32FQ95xx Reference Manual

25.2.7. FIFO Control register (UART_FCR) .................................................................................376
25.2.8. Line control register (UART_LCR) ...................................................................................376
25.2.9. Modem control register (UART_MCR) .............................................................................377
25.2.10. 27.2.10 Line status register (UART_LSR) .....................................................................377
25.2.11. Modem status register (UART_MSR) ............................................................................379
25.2.12. High speed temporary register (UART_SCR) ................................................................379
25.2.13. UART Status register (UART_USR) ..............................................................................380
25.2.14. Transmit FIFO level register (UART_TFL) .....................................................................380
25.2.15. Receive FIFO level register
25.2.16. Software restart register

(UART_RFL) .................................................................380
(UART_SRR) .....................................................................380

25.2.17. Shadow TX request register (UART_SRTS) ..................................................................381
25.2.18. Shadow interrupt control register (UART_SBCR) ..........................................................381
25.2.19. Shadow FIFO enable register (UART_SFE) ..................................................................381
25.2.20. Shadow receive trigger register (UART_SRT) ...............................................................381
25.2.21. Shadow TX trigger register (UART_STET) ....................................................................382
25.2.22. DMA Software abort register (UART_DMASA) ..............................................................382
25.2.23. Fractional latch register (UART_DLF) ............................................................................382
25.2.24. Receive address register (UART_RAR) ........................................................................382
25.2.25. TX address register (UART_TAR) ..................................................................................382
25.2.26. Extended control register (UART_EXTLCR)..................................................................383
26. Device electronic signature ..................................................................................................................384
26.1. Overview ....................................................................................................................................384
26.2. Memory size registers ................................................................................................................384
26.3. Unique device ID register (96 bits) .............................................................................................384
26.4. MCU device ID register (MCU_ID) .............................................................................................384
27. Debug (DBG) ........................................................................................................................................385
27.1. Overview ....................................................................................................................................385
27.2. JTAG/SW function overview .......................................................................................................385
27.2.1. Switch JTAG or SW interface ...........................................................................................385
27.2.2. Pin assignment.................................................................................................................386
27.2.3. JEDEC-106 ID code .........................................................................................................386
27.3. Debug hold function overview ....................................................................................................386
27.3.1. Debug support for power saving mode ............................................................................386
27.3.2. Debug support for TIMER, WWDG, IWDG ......................................................................387
27.4. Register definition .......................................................................................................................387
27.4.1. ID code register (DBG_ID) ...............................................................................................387
27.4.2. Control register (DBGMCU_CR) ......................................................................................387

Doc ID 2905025

Rev01

17

WB32FQ95xx Reference Manual

List of Figures
Figure 2-1. The structure of the Cortex™-M3 processor ..................................................................... 27
Figure 2-2. WB32FQ95xx Medium-density series system architecture ............................................... 28
Figure 6-1. Power on reset/power down reset waveform .................................................................... 51
Figure 8-1. Clock tree ........................................................................................................................... 73
Figure 11-1. Block diagram of EXTI ................................................................................................... 109
Figure 14-1. Block Diagram ................................................................................................................ 127
Figure 14-2. Arbitration Flow for Master Bus Interface ...................................................................... 129
Figure 14-3. DMA single data transfer ............................................................................................... 130
Figure 14-4. DMA burst data transfer ................................................................................................. 130
Figure 14-5. Example of Destination Scatter Transfer ....................................................................... 131
Figure 14-6. Source Gather when SGR.SGI=0x1 .............................................................................. 132
Figure 15-1. ADC block diagram ........................................................................................................ 153
Figure 15-2. ADC sequence diagram ................................................................................................. 155
Figure 15-3. ADC simulated watchdog alert area .............................................................................. 156
Figure 15-4. ADC calibration sequence diagram ............................................................................... 159
Figure 15-5. Left alignment of data .................................................................................................... 159
Figure 15-6. Right alignment of data .................................................................................................. 159
Figure 16-1. Advanced timer block diagram ....................................................................................... 174
Figure 16-2. Normal mode, internal clock divided by 1 ...................................................................... 175
Figure 16-3. Counter timing diagram with prescaler division change from 1 to 4 .............................. 176
Figure 16-4. Up-counter timechart, PSC=0 ........................................................................................ 177
Figure 16-5. Up-counter timechart, PSC=1 ........................................................................................ 177
Figure 16-6. Up-counter timechart, PSC=3 ........................................................................................ 177
Figure 16-7. Up-counter timechart, PSC=N ....................................................................................... 178
Figure 16-8. Up-counter timechart, change TIMx_ARR on the go ..................................................... 178
Figure 16-9. Down-counter timechart, PSC=0 ................................................................................... 179
Figure 16-10. Down-counter timechart, PSC=1 ................................................................................. 179

Doc ID 110200

Rev01

18

WB32FQ95xx Reference Manual

Figure 16-11. Down-counter timechart, PSC=3 ................................................................................. 179
Figure 16-12. Down-counter timechart, PSC=N ................................................................................ 180
Figure 16-13. Down-counter timechart, change TIMx_ARR on the go (APRE=0)............................. 180
Figure 16-14. Center-aligned counter timechart, PSC=0 ................................................................... 181
Figure 16-15. Center-aligned counter timechart, PSC=1 ................................................................... 181
Figure 16-16. Center-aligned counter timechart, PSC=3 ................................................................... 182
Figure 16-17. Center-aligned counter timechart, PSC=N .................................................................. 182
Figure 16-18. Center-aligned counter timechart, update event with ARPE=1 (counter underflow) ... 182
Figure 16-19. Center-aligned counter timechart, update event with ARPE=1 (counter overflow) ..... 183
Figure 16-20. Repetition time chart for center-aligned counter .......................................................... 183
Figure 16-21. Input capture logic ....................................................................................................... 184
Figure 16-22. Output-compare mode, toggle on OC1. ...................................................................... 185
Figure 16-23. EAPWM waveforms (ARR=8) ...................................................................................... 186
Figure 16-24. CAPWM waveforms (ARR=8) ..................................................................................... 186
Figure 16-25. Complementary output with dead-time insertion ......................................................... 189
Figure 16-26. Output behavior in response to a break (The break high active) ................................ 190
Figure 16-27. Example of counter operation in encoder interface mode ........................................... 191
Figure 16-28. Example of encoder interface mode with CI1FE0 polarity inverted ............................. 191
Figure 16-29. Hall sensor is used to BLDC motor.............................................................................. 192
Figure 16-30. Hall sensor timing between two timers ........................................................................ 192
Figure 16-31. Single pulse mode, TIMx_CCRx = 0x04, TIMx_ARR=0x60 ........................................ 193
Figure 16-32. Timer1 master/slave mode timer example ................................................................... 194
Figure 16-33. Triggering Timer1 with enable signal of TIMER2 ......................................................... 195
Figure 16-34. Triggering Timer1 with update signal of TIMER2 ......................................................... 195
Figure 16-35. Pause Timer1 with enable signal of TIMER2 ............................................................... 196
Figure 16-36. Pause Timer1 with O1CPREF signal of Timer2 ........................................................... 197
Figure 16-37. Triggering Timer1 and TIMER2 with TIMER2’s TI1 input ............................................ 197
Figure 17-1. General-purpose timer block diagram ........................................................................... 217
Figure 17-2. Normal mode, internal clock divided by 1 ...................................................................... 218

Doc ID 110200

Rev01

19

WB32FQ95xx Reference Manual

Figure 17-3. Counter timing diagram with prescaler division change from 1 to 4 .............................. 219
Figure 17-4. Up-counter timechart, PSC=0 ........................................................................................ 219
Figure 17-5. Up-counter timechart, PSC=1 ........................................................................................ 220
Figure 17-6. Up-counter timechart, PSC=3 ........................................................................................ 220
Figure 17-7. Up-counter timechart, PSC=N ....................................................................................... 220
Figure 17-8. Up-counter timechart, change TIMx_ARR on the go ............................................... 221
Figure 17-9. Down-counter timechart, PSC=0 ................................................................................... 222
Figure 17-10. Down-counter timechart, PSC=1 ................................................................................. 222
Figure 17-11. Down-counter timechart, PSC=3 ................................................................................. 222
Figure 17-12. Down-counter timechart, PSC=N ............................................................................ 223
Figure 17-13. Down-counter timechart, change TIMx_ARR on the go (APRE=0)............................. 223
Figure 17-14. Center-aligned counter timechart, PSC=0 ................................................................... 224
Figure 17-15. Center-aligned counter timechart, PSC=1 ................................................................... 224
Figure 17-16. Center-aligned counter timechart, PSC=3 ................................................................... 225
Figure 17-17. Center-aligned counter timechart, PSC=N .................................................................. 225
Figure 17-18. Center-aligned counter timechart, update event with ARPE=1 (counter underflow) ... 225
Figure 17-19. Center-aligned counter timechart, update event with ARPE=1 (counter overflow) ..... 226
Figure 17-20. Input capture logic ....................................................................................................... 226
Figure 17-21. Output-compare mode, toggle on OC1 ....................................................................... 228
Figure 17-22. EAPWM waveforms (ARR=8) ...................................................................................... 228
Figure 17-23. CAPWM waveforms (ARR=8) ..................................................................................... 229
Figure 17-24. Example of counter operation in encoder interface mode ........................................... 230
Figure 17-25. Example of encoder interface mode with CI1FE0 polarity inverted ............................. 231
Figure 17-26. Hall sensor is used to BLDC motor.............................................................................. 232
Figure 17-27. Hall sensor timing between two timers .................................................................. 232
Figure 17-28. Single pulse mode, TIMx_CCRx = 0x04, TIMx_ARR=0x60 ........................................ 233
Figure 18-1. Block diagram of RTC .................................................................................................... 250
Figure 18-2. RTC second and alarm waveform example (RTC_PSC = 3, RTC_ALRM = 4) ............ 251
Figure 18-3. RTC second and overflow waveform example (RTC_PSC= 3) ..................................... 252

Doc ID 110200

Rev01

20

WB32FQ95xx Reference Manual

Figure 19-1. Free watchdog block diagram ........................................................................................ 255
Figure 20-1. Window watchdog timer block diagram ......................................................................... 258
Figure 20-2. Window watchdog timing diagram ................................................................................. 259
Figure 21-1. Flash connection Figure ................................................................................................ 261
Figure 22-1. USB Interrupt handling ............................................................................................... 265
Figure 22-2. ENDPOINT 0 STATES ................................................................................................... 269
Figure 22-3. ENDPOINT 0 SERVICE ROUTINE ............................................................................... 271
Figure 22-4. SETUP Phase of Control Transfer ................................................................................. 272
Figure 22-5. IN Data Phase for Control transfer ................................................................................ 273
Figure 22-6. OUT Data Phase for Control Transfer ........................................................................... 274
Figure 23-1. SPI structure .................................................................................................................. 291
Figure 23-2. SPI connection diagram ................................................................................................. 292
Figure 23-3. SPI clock mode: CPHA = 0 ............................................................................................ 292
Figure 23-4. SPI clock mode: CPHA = 1 ............................................................................................ 292
Figure 24-1. QSPI connection diagram .............................................................................................. 313
Figure 26-1. Block Diagram ................................................................................................................ 324
Figure 26-2. START and STOP Condition.......................................................................................... 325
Figure 26-3. I2C Bus Protocol ............................................................................................................ 325
Figure 26-4. 7-bit Addressing Format ................................................................................................. 326
Figure 26-5. 10-bit Address Format ................................................................................................... 326
Figure 26-6. Master-Transmitter Protocol .......................................................................................... 327
Figure 26-7. Master-Receiver Protocol .............................................................................................. 328
Figure 26-8. START BYTE Transfer ................................................................................................... 328
Figure 26-9. Multiple Master Arbitration ............................................................................................. 329
Figure 26-10. Bus Clear Flow............................................................................................................. 334
Figure 26-11. Reading Device ID ....................................................................................................... 335
Figure 27-1. RS232 Serial data format .............................................................................................. 369
Figure 27-2. 9-bit transmission data format ....................................................................................... 369
Figure 27-3. Infrared transmission data format .................................................................................. 371

Doc ID 110200

Rev01

21

WB32FQ95xx Reference Manual

Figure 27-4. Automatic RTS function sequence diagram................................................................... 372
Figure 27-5. Automatic CTS function sequence diagram .................................................................. 372
Figure 30-1. WB32FQ95xx debugging block diagram ....................................................................... 385
Figure 30-2. WB32FQ95xx only support debug with SWD interface. ................................................ 386

Doc ID 110200

Rev01

22

WB32FQ95xx Reference Manual

List of Tables
Table 2-1. The interconnection relationship of the AHB interconnect matrix........................................ 27
Table 2-2. Memory map of WB32FQ95xx devices ............................................................................... 29
Table 2-3. Boot modes ......................................................................................................................... 35
Table 3-1. Security level configuration ................................................................................................. 37
Table 3-2. Information write protection ................................................................................................. 38
Table 3-3. User program space protection ........................................................................................... 39
Table 3-4. User space write protection (read protect enabled)(low density product) ........................... 40
Table 3-5. User space write protection (read protect enabled)(high density product) ......................... 40
Table 6-1. Power supply overview ........................................................................................................ 49
Table 6-2. Low-power mode summary ................................................................................................. 52
Table 6-3. Sleep-now ............................................................................................................................ 54
Table 6-4. Sleep-on-exit ....................................................................................................................... 54
Table 6-5. Four Stop Modes ................................................................................................................. 55
Table 6-6. Stop mode ........................................................................................................................... 56
Table 6-7. Standby mode ..................................................................................................................... 57
Table 6-8. Analog state in different power mode .................................................................................. 58
Table 9-1. Port bit configuration table ................................................................................................... 90
Table 9-2. Pin function selection .......................................................................................................... 95
Table 10-1. WB32FQ95xx vectors ..................................................................................................... 106
Table 11-1. EXTI source ...................................................................................................................... 110
Table 12-1. HSE mode configuration .................................................................................................. 114
Table 12-2. PLL frequency configuration ............................................................................................. 114
Table 12-3. PVD voltage threshold selection ...................................................................................... 115
Table 14-1. DMA Request Mapping ................................................................................................... 135
Table 15-1. ADC PINS ........................................................................................................................ 153
Table 15-2. ADC analog watchdog channel selection ........................................................................ 156
Table 15-3. External trigger for regular channels ............................................................................... 160

Doc ID 110200

Rev01

23

WB32FQ95xx Reference Manual

Table 15-4. External trigger for injected channels .............................................................................. 160
Table 15-5. ADC interrupt ................................................................................................................... 162
Table 16-1. Complementary outputs controlled by parameters ......................................................... 187
Table 16-2. Counting direction versus encoder signals ..................................................................... 190
Table 17-1. Counting direction versus encoder signals ..................................................................... 230
Table 19-1. Min/max IWDG timeout period at 32 KHz (LSI 32K) ....................................................... 256
Table 21-1. CRC Calculation configure .............................................................................................. 262
Table 22-1. Dedicated RAM allocation table ...................................................................................... 264
Table 22-2. USB Registers ................................................................................................................. 281
Table 26-1. I2C1 and I2C2 Features .................................................................................................. 324
Table 26-2. I2C/SMBus Definition of Bits in First Bye ........................................................................ 326
Table 27-1. Decimal values for divisor latch ....................................................................................... 370
Table 27-2. UART interrupt handling .................................................................................................. 375

Doc ID 110200

Rev01

24

