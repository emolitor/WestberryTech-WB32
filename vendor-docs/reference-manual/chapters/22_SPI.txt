WB32FQ95xx Reference Manual

22.

Serial peripheral interface (SPI)

22.1.

Introduction
Serial peripheral interface (SPI) allows the chip to communicate with external devices in half
/full duplex, synchronous and serial mode. This interface can be configured as a master
mode or a slave mode to communicate with external devices.
There are two independent slave mode SPI modules and one master mode SPI module in
the chip.

22.2.

SPI features
Each SPI module has the following characteristics:
⚫

APB interface

⚫

Support DMA transmission

⚫

Two data FIFO s with depth of 4 and width of 16 bits, corresponding to Transfer and
receiving respectively

⚫

Four configurable clock modes

⚫

The data format is right aligned

⚫

Support Motorola SPI protocol

⚫

Support Texas Instruments SSP protocol

⚫

Support National Semiconductor Microwire protocol
Figure 22-1. SPI structure

Doc ID 2905025

Rev01

291

WB32FQ95xx Reference Manual

Figure 22-2. SPI connection diagram

22.3.

Clock mode
Four clock modes are supported:
⚫

CPOL,CPHA = 00

⚫

CPOL,CPHA = 01

⚫

CPOL,CPHA = 10

⚫

CPOL,CPHA = 11

The CPOL and CPHA bits of SPI_CR0 register can be combined into four possible timing
relationships.
The CPOL bit controls the level of the clock in the idle state. This bit is valid for both master
mode and slave mode devices; If CPOL = 0, SCLK is idle If CPOL = 1, SCLK remains high in
idle state.
The CPHA bit controls the phase of the clock. If CPHA = 0, the clock edge appears in the
middle of the data bit, and when the data begins to transmit, the second edge of SCLK is
used for data sampling; if CPHA = 1, the clock edge appears at the beginning of the data bit,
and when the data begins to transmit, the second edge of SCLK appears is used for data
sampling.
Figure 22-3. SPI clock mode: CPHA = 0

Figure 22-4. SPI clock mode: CPHA = 1

Doc ID 2905025

Rev01

292

WB32FQ95xx Reference Manual

22.4.

Transfer Modes
When transmitting data on the serial bus, three transfer modes are supported, which is
controlled by TMOD bit of register SPI_CR0.
Transmit & Receive
When TMOD = 2‘b00, both transmit and receive logic are valid. The data transfer occurs as
normal according to the selected frame format (serial protocol). Transmit data are popped
from the transmit FIFO and sent through the TXD line to the target device, which replies with
data on the RXD line. The receive data from the target device is moved from the receive shift
register into the receive FIFO at the end of each data frame.
Transmit Only
When TMOD = 2‘b01, the receive data are invalid and should not be stored in the receive
FIFO. The data transfer occurs as normal, according to the selected frame format (serial
protocol). Transmit data are popped from the transmit FIFO and sent through the TXD line to
the target device, which replies with data on the RXD line. At the end of the data frame, the
receive shift register does not load its newly received data into the receive FIFO. The data in
the receive shift register is overwritten by the next transfer. You should mask interrupts
originating from the receive logic when this mode is entered.
Receive Only
When TMOD = 2‘b10, the transmit data are invalid. When configured as a slave, the transmit
FIFO is never popped in Receive Only mode. The TXD output remains at a constant logic
level during the transmission. The data transfer occurs as normal according to the selected
frame format (serial protocol). The receive data from the target device is moved from the
receive shift register into the receive FIFO at the end of each data frame. You should mask
interrupts originating from the transmit logic when this mode is entered.

22.5.

SPI slave mode
There are two independent slave mode SPI modules in the chip: SPIS1and SPIS2.
SPIS1 is on the APB1 bus and SPIS2 is on the APB2 bus. The two slave mode SPI modules
can communicate with the master mode SPI device outside the chip. All serial transfers are
initiated and controlled by the serial bus master. The SCLK clock is controlled by the master
mode device, and the clock mode (CPOL, CPHA) of the slave mode device must be the
same as that of the master mode device.
The serial slave enables its TXD data onto the serial bus. All data transfers to and from the
serial slave are regulated on the serial clock line, driven from the serial-master device. Data
are propagated from the serial slave on one edge of the serial clock line and sampled on the
opposite edge.
The serial slave remains in an idle state until selected by the bus master. When not actively
transmitting data, the slave must hold its TXD line in a high impedance state to avoid
interference with serial transfers to other slave devices. The slave continues to transfer data
to and from the master device as long as it is selected.
Note: Before the master mode device sends the clock, the slave mode module must be
configured and the data FIFO of them must be ready, otherwise unexpected data
transmission error may occur.

Doc ID 2905025

Rev01

293

WB32FQ95xx Reference Manual

GPIO configuration
⚫

⚫

SPIS1 pin configuration. If SPIS1 is used, the following GPIO should be configured first:
◼

SSN corresponds to GPIOA PORT4 or GPIOA PORT15, and the alternate mode
should be configured to 6

◼

SCLK corresponds to GPIOA PORT5 or GPIOB PORT3, and the alternate mode
should be configured to 6

◼

MISO corresponds to GPIOA PORT6 or GPIOB PORT4, and the alternate mode
should be configured to 6

◼

MOSI corresponds to GPIOA PORT7 or GPIOB PORT5, and the alternate mode
should be configured to 6

SPIS2 pin configuration. If SPIS2 is used, the following GPIO
first:

should be configured

◼

SSN corresponds to GPIOB port 12 or GPIOC port 0, and the alternate mode of the
port is configured to 6

◼

SCLK corresponds to GPIOB port 13 or GPIOC port 1, and the alternate mode
should be configured to 6

◼

MISO corresponds to GPIOB port 14 or GPIOC port 2, and the alternate mode
should be configures to 6

◼

MOSI corresponds to GPIOB PORT 15 or GPIOC PORT 3, and the alternate mode
should be configured to 6

Slave SPI and SSP Serial Transfers
If the serial slave is receive only (TMOD=10), the transmit FIFO need not contain valid data
because the data currently in the transmit shift register is resent each time the slave device is
selected. The TXE error flag in the status register (SR) is not set when TMOD=01. You
should mask the transmit FIFO empty interrupt when this mode is used.
If the serial slave transmits data to the master, you must ensure that data exists in the
transmit FIFO before a transfer is initiated by the serial-master device. If the master initiates
a transfer to the slave when no data exists in the transmit FIFO, an error flag (TXE) is set in
the status register, and the previously transmitted data frame is resent on TXD. For
continuous data transfers, you must ensure that the transmit FIFO buffer does not become
empty before all the data have been transmitted. The transmit FIFO threshold level register
(TXFTLR) can be used to generate early interrupt to the processor, indicating that the
transmit FIFO buffer is nearly empty. When a DMA Controller is used for APB accesses, the
DMA transmit data level register (DMATDLR) can be used to early request the DMA
Controller, indicating that the transmit FIFO is nearly empty. The FIFO can then be refilled
with data to continue the serial transfer.
The receive FIFO buffer should be read each time the receive FIFO generates a FIFO full
interrupt request to prevent an overflow. The receive FIFO threshold level register (RXFTLR)
can be used to give early indication that the receive FIFO is nearly full. When a DMA
Controller is used for APB accesses, the DMA receive data level register (DMARDLR) can
be used to early request the DMA controller, indicating that the receive FIFO is nearly full.
A typical software flow for completing a continuous serial transfer from a serial master to the
slave is described as follows:
Doc ID 2905025

Rev01

294

WB32FQ95xx Reference Manual

⚫

If the slave is enabled, disable it by writing 0 to SSIENR.

⚫

Set up the slave control registers for the transfer. These registers can be set in any
order.
◼

Write CTRLR0 (for SPI transfers SCPH and SCPOL must be set identical to the
master device).

◼

Write TXFTLR and RXFTLR to set FIFO threshold levels.

◼

Write the IMR register to set up interrupt masks.

⚫

Enable the serial slave by writing 1 to the SSIENR register.

⚫

If the transfer mode is transmit and receive (TMOD=2'b00) or transmit only
(TMOD=2'b01), write data for transmission to the master into the transmit FIFO (Write
DR).

⚫

If the transfer mode is receive only (TMOD=2'b10), there is no need to write data into
the transmit FIFO; the current value in the transmit shift register is retransmitted.

⚫

The slave is now ready for the serial transfer. The transfer begins when the slave is
selected by a serial-master device.

⚫

When the transfer is underway, the BUSY status can be polled to return the transfer
status. If a transmit FIFO empty interrupt request is made, write the transmit FIFO (write
DR). If a receive FIFO full interrupt request is made, read the receive FIFO (read DR).

⚫

The transfer ends when the serial master removes the select input to the slave. When
the transfer is completed, the BUSY status is reset to 0.

⚫

If the transfer mode is not transmit only (TMOD!=2’b01), read the receive FIFO until
empty.

⚫

Disable the slave by writing 0 to SSIENR.

Slave Microwire Serial Transfers
As a slave device, the Microwire protocol operates in much the same way as the SPI
protocol. There is no decode of the control frame by the slave device.

22.6.

SPI master mode
There is a master mode SPI module in the chip, which is located on the APB2 bus.
The master mode SPI control the SCLK clock, and use SPI_ BAUDR register to configure
the baud rate. The master initiates and controls all serial transfers on the bus. When the
master is disabled, no serial transfers can occur and the SCLK clock is held in inactive state.
Data transfers are started by the serial-master device. When the master is enabled
(SSI_EN=1), at least one valid data entry is present in the transmit FIFO and a serial-slave
device is selected. When actively transferring data, the busy flag (BUSY) in the status
register (SR) is set. You must wait until the busy flag is cleared before attempting a new
serial transfer.
The master mode module can drive three SSN output signals, corresponding to three
external slave mode devices.
GPIO configuration

Doc ID 2905025

Rev01

295

WB32FQ95xx Reference Manual

For the master mode pin configuration, the following GPIO should be configured: (please
refer to the GPIO register section)
⚫

SSN0 corresponds to GPIOB port 12 or GPIOC port 0. Configure the port as output
mode and the port's alternate mode as 5

⚫

SSN1 corresponds to GPIOB port 7 or GPIOB port 11. Configure the port as output
mode and the port's alternate mode as 5

⚫

SSN2 corresponds to GPIOB port 8 or GPIOC port 5. Configure the port as output mode
and the port's alternate mode as 5

⚫

SCLK corresponds to GPIOB port 13 or GPIOC port 1. Configure the port as output
mode and the port's alternate mode as 5

⚫

MISO corresponds to GPIOB port 14 or GPIOC port 2, configures the port as input
mode, and configures the port's alternate mode as 5

⚫

MOSI corresponds to GPIOB port 15 or GPIOC port 3, which is configured as output
mode, and the port's alternate mode is configured as 5

Master SPI and SSP Serial Transfers
When the transfer mode is “transmit and receive” or “transmit only” (TMOD = 2'b00 or TMOD
= 2'b01, respectively), transfers are terminated by the shift control logic when the transmit
FIFO is empty.
For continuous data transfers, you must ensure that the transmit FIFO buffer does not
become empty before all the data have been transmitted. The transmit FIFO threshold level
(TXFTLR) can be used to generate early interrupt to the processor indicating that the
transmit FIFO buffer is nearly empty. When a DMA is used for APB accesses, the transmit
data level (DMATDLR) can be used to early request to the DMA Controller, indicating that the
transmit FIFO is nearly empty. The FIFO can then be refilled with data to continue the serial
transfer. The user may also write a block of data (at least two FIFO entries) into the transmit
FIFO before enabling a serial slave. This ensures that serial transmission does not begin
until the number of data-frames that make up the continuous transfer are present in the
transmit FIFO.
When the transfer mode is “receive only” (TMOD = 2'b10), a serial transfer is started by
writing one “dummy” data word into the transmit FIFO when a serial slave is selected. The
TXD output is held at a constant logic level for the duration of the serial transfer. The transmit
FIFO is popped only once at the beginning and may remain empty for the duration of the
serial transfer. The end of the serial transfer is controlled by the “number of data frames”
(NDF) field in control register 1 (CTRLR1).
If, for example, you want to receive 24 data frames from a serial-slave peripheral, you
should program the NDF field with the value 23; the receive logic terminates the serial
transfer when the number of frames received is equal to the NDF value + 1. This transfer
mode increases the bandwidth of the APB bus as the transmit FIFO never needs to be
serviced during the transfer. The receive FIFO buffer should be read each time the receive
FIFO generates a FIFO full interrupt request to prevent an overflow.
The receive FIFO threshold level (RXFTLR) can be used to give early indication that the
receive FIFO is nearly full. When a DMA is used for APB accesses, the receive data level
(DMARDLR) can be used to early request to the DMA Controller, indicating that the receive
FIFO is nearly full.

Doc ID 2905025

Rev01

296

WB32FQ95xx Reference Manual

A typical software flow for completing an SPI or SSP serial transfer from the serial master is
outlined as follows:
⚫

If the master is enabled, disable it by writing 0 to the SSI Enable register (SSIENR).

⚫

Set up the master control registers for the transfer; these registers can be set in any
order.
◼

Write Control Register 0 (CTRLR0). For SPI transfers, the serial clock polarity and
serial clock phase parameters must be set identical to target slave device.

◼

If the transfer mode is receive only, write CTRLR1 (Control Register 1) with the
number of frames in the transfer minus 1; for example, if you want to receive four
data frames, write this register with 3.

◼

Write the Baud Rate Select Register (BAUDR) to set the baud rate for the transfer.

◼

Write the Transmit and Receive FIFO Threshold Level registers (TXFTLR and
RXFTLR, respectively) to set FIFO threshold levels.

◼

Write the IMR register to set up interrupt masks.

◼

The Slave Enable Register (SER) register can be written here to enable the target
slave for selection. If a slave is enabled here, the transfer begins as soon as one
valid data entry is present in the transmit FIFO. If no slaves are enabled prior to
writing to the Data Register (DR), the transfer does not begin until a slave is
enabled.

⚫

Enable the master by writing 1 to the SSIENR register.

⚫

Write data for transmission to the target slave into the transmit FIFO (write DR).If no
slaves were enabled in the SER register at this point, enable it now to begin the transfer.

⚫

Poll the BUSY status to wait for completion of the transfer. The BUSY status cannot be
polled immediately; for more information, see the note on page 52.If a transmit FIFO
empty interrupt request is made, write the transmit FIFO (write DR). If a receive FIFO
full interrupt request is made, read the receive FIFO (read DR).

⚫

The transfer is stopped by the shift control logic when the transmit FIFO is empty. If the
transfer mode is receive only (TMOD = 2'b10), the transfer is stopped by the shift control
logic when the specified number of frames have been received. When the transfer is
done, the BUSY status is reset to 0.

⚫

If the transfer mode is not transmit only (TMOD != 2’b01), read the receive FIFO until it
is empty.

⚫

Disable the master by writing 0 to SSIENR.

Master Microwire Serial Transfers
Microwire serial transfers from the serial master are controlled by the Microwire Control
Register (MWCR). The MWHS bit enables and disables the Microwire handshaking interface.
The MDD bit controls the direction of the data frame (the control frame is always transmitted
by the master and received by the slave). The MWMOD bit defines whether the transfer is
sequential or non-sequential.
All Microwire transfers are started by the serial master when there is at least one control
word in the transmit FIFO and a slave is enabled. When the master transmits the data frame
(MDD = 1), the transfer is terminated by the shift logic when the transmit FIFO is empty.
Doc ID 2905025

Rev01

297

WB32FQ95xx Reference Manual

When the master receives the data frame (MDD = 1), the termination of the transfer depends
on the setting of the MWMOD bit. If the transfer is non-sequential (MWMOD = 0), it is
terminated when the transmit FIFO is empty after shifting in the data frame from the slave.
When the transfer is sequential (MWMOD = 1), it is terminated by the shift logic when the
number of data frames received is equal to the value in the CTRLR1 register + 1.
When the handshaking interface on the master is enabled (MWHS =1), the status of the
target slave is polled after transmission. Only when the slave reports a ready status does the
master complete the transfer and clear its BUSY status. If the transfer is continuous, the next
control/data frame is not sent until the slave device returns a ready status.
A typical software flow for completing a Microwire serial transfer from the serial master is
outlined as follows:
⚫

If the master is enabled, disable it by writing 0 to SSIENR.

⚫

Set up the master control registers for the transfer. These registers can be set in any
order. Write CTRLR0 to set transfer parameters.
◼

If the transfer is sequential and the master receives data, write CTRLR1 with the
number of frames in the transfer minus 1; for instance, if you want to receive four
data frames, write this register with 3.

◼

Write BAUDR to set the baud rate for the transfer.

◼

Write TXFTLR and RXFTLR to set FIFO threshold levels.

◼

Write the IMR register to set up interrupt masks.
You can write the SER register to enable the target slave for selection. If a slave is
enabled here, the transfer begins as soon as one valid data entry is present in the
transmit FIFO. If no slaves are enabled prior to writing to the DR register, the
transfer does not begin until a slave is enabled.

⚫

Enable the master by writing 1 to the SSIENR register.

⚫

If the master transmits data, write the control and data words into the transmit FIFO
(write DR). If the master receives data, write the control word(s) into the transmit FIFO.

⚫

If no slaves were enabled in the SER register at this point, enable now to begin the
transfer.

⚫

Poll the BUSY status to wait for completion of the transfer. The BUSY status cannot be
polled immediately.

⚫

If a transmit FIFO empty interrupt request is made, write the transmit FIFO (write DR). If
a receive FIFO full interrupt request is made, read the receive FIFO (read DR).

⚫

The transfer is stopped by the shift control logic when the transmit FIFO is empty. If the
transfer mode is sequential and the master receives data, the transfer is stopped by the
shift control logic when the specified number of data frames is received. When the
transfer is done, the BUSY status is reset to 0.

⚫

If the master receives data, read the receive FIFO until it is empty.

⚫

Disable the master by writing 0 to SSIENR.

Doc ID 2905025

Rev01

298

WB32FQ95xx Reference Manual

22.7.

DMA transmission
Transfer and receiving both support DMA transmission, and users can set DMA threshold
separately for transfer and receive to trigger DMA transmission.
DMA transfer threshold: set by the register SPI_DMATDLR. When the amount of data in the
transmission FIFO is equal to or less than the DMA transfer threshold, a DMA request will be
generated to the DMA controller on the bus.
DMA receiving threshold: set by register SPI_DMARDLR. When the amount of data in the
receiving FIFO is equal to or greater than the DMA receiving threshold, a DMA request will
be generated to the DMA controller on the bus.

22.8.

Interrupts
Each SPI module has five interrupt sources, but only one interrupt signal is output. When the
CPU receives the interrupt, it needs to read the SPI interrupt register to determine the
interrupt source.
⚫

Interrupt source:

⚫

◼

Transmit FIFO empty: generated when the data to be sent in the Transmit FIFO is
equal to or less than the set threshold

◼

Transmit FIFO overflow: occurs when the transmit FIFO is full and new data is
attempted to be written from the APB bus.

◼

Receive FIFO full: when the data stored in the receive FIFO is equal to or greater
than the set threshold.

◼

Receive FIFO overflow: when the receive FIFO is full and new data is received.

◼

Receive FIFO underflow: occurs when the receive FIFO is empty and an attempt is
made to read data from the APB bus.

FIFO threshold:
◼

Set thresholds for Transmit FIFO and receive FIFO to better control the amount of
data. If you do not set thresholds, the default threshold is the maximum capacity of
send FIFO and receive FIFO.

22.9.

SPI Slave mode register

22.9.1.

SPI Control register 0(SPI_CR0)
Address offset: 0x000
Reset value: 0x0100_0007
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:25

-

Res

Reserved

24

SSTE

RW

When CPHA = 0, SSTE sets the state of SSN signal between data frames.
SSTE = 1: SSN remains 1 between two consecutive data frames.
SSTE = 0: SSN remains 0 between two consecutive data frames

Doc ID 2905025

Description

Rev01

299

WB32FQ95xx Reference Manual

Bits

Fields

R/W

Description

23:16

-

Res

Reserved

15:12

CFS

RW

Control Frame Size. Selects the length of the control word for the Microwire
frame format.
0000: the control word is 1 bit
0001: the control word is 2 bits
0010: the control word is 3 bits
.............
1111: the control word is 16 bits

11

-

Res

Reserved

10

SLVOE

RW

9:8

TMOD

RW

7

CPOL

RW

6

CPHA

RW

5:4

FRF

RW

3:0

DFS

RW

22.9.2.

Slave output enable
0: disable output from salve mode device
1: Allow output from slave mode device
Transfer Mode.
Selects the mode of transfer for serial communication. This field does not
affect the transfer duplicity. Only indicates whether the receive or transmit
data are valid.
00: both Transfer and receive are valid
01: send only valid
10: Receive only valid
11: Invalid setting, setting to 11 is not allowed
Clock polarity
0: SCLK remains low in idle state
1: In idle state, SCLK remains high
Serial Clock phase,
0: data sampling starts from the first clock edge
1: Data sampling starts at the edge of the second clock
Protocol selection
00: Motorola SPI protocol
01: Texas Instruments SSP protocol
10: National Semiconductor Microwire protocol
11: Invalid setting, setting to 11 is not allowed
Data frame length
0000: Invalid setting, setting to 0000 is not allowed
0001: Invalid setting, setting to 0001 is not allowed
0010: Invalid setting, setting to 0010 is not allowed
0011: The data frame length is 4bit
0100: The data frame length is 5bit
0101: The data frame length is 6bit
.............
1111: The data frame length is 16bit

SPI Enable register (SPI_SPIENR)
Address offset: 0x008
Reset value: 0x0000_0000

Bits

Fields

R/W

31:1

-

Res

Reserved

0

SPI_EN

RW

SPI enable

Doc ID 2905025

Description

Rev01

300

WB32FQ95xx Reference Manual

22.9.3.

MICROWIRE Control register (SPI_MWCR)
Address offset: 0x00C
Reset value: 0x0000_0000
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:2

-

Res

1

MDD

RW

0

MWMOD

RW

22.9.4.

Description
Reserved
data transmission
0: receive data
1: send data
Continuous transmission control
0: Single transmission
1: Continuous transmission

TX FIFO threshold register (SPI_TXFTLR)
Address offset: 0x018
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

TFT

RW

TX FIFO threshold
Controls the level of entries (or below) at which the transmit
FIFO controller triggers an interrupt.

22.9.5.

Description

Receive FIFO threshold register (SPI_RXFTLR)
Address offset: 0x01C
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

RW

Receive FIFO threshold
Controls the level of entries (or above) at which the receive FIFO controller
triggers an interrupt.

1:0

22.9.6.

RFT

Description

TX FIFO status register (SPI_TXFLR)
Address offset: 0x020
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

TXTFL

R

Contains the number of valid data entries in the transmit FIFO.

Doc ID 2905025

Description

Rev01

301

WB32FQ95xx Reference Manual

22.9.7.

Receive FIFO status register (SPI_RXFLR)
Address offset: 0x024
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

RXTFL

R

Contains the number of valid data entries in the receive FIFO.

22.9.8.

Description

SPI Status register (SPI_SR)
Address offset: 0x028
Reset value: 0x0000_0006

Bits

Fields

R/W

31:6

-

Res

Reserved

5

TXERR

RC_R

When the transmit FIFO is empty and transmit is started, it will be set to 1.
Reading this register will clear this bit

4

RFF

R

3

RFNE

R

2

TFE

R

1

TFNF

R

Set 1 when the transmit FIFO is not full and 0 when the transmit FIFO is full

0

BUSY

R

Set 1 when transmission is in progress and 0 when all transmission ends

22.9.9.

Description

Set 1 when the receive FIFO is full and 0 when the receive FIFO

is not full

Set 1 when the receive FIFO is not empty and 0 when the receive FIFO is
empty
Set 1 when the transmit FIFO is empty and 0 when the transmit FIFO is not
empty

Interrupt enable register (SPI_IER)
Address offset: 0x02C
Reset value: 0x0000_001F

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIE

RW

Write 0 to mask receive FIFO full interrupt

3

RXOIE

RW

Write 0 to mask receive FIFO overflow interrupt

2

RXUIE

RW

Write 0 to mask receive FIFO underflow interrupt

1

TXOIE

RW

Writing 0 masks the overflow interrupt on the send FIFO

0

TXEIE

RW

Write 0 to mask send FIFO null interrupt

22.9.10.

Description

Interrupt status register (SPI_ISR)
Address offset: 0x030
Reset value: 0x0000_0000

Doc ID 2905025

Rev01

302

WB32FQ95xx Reference Manual

Description: This status register is affected by interrupt enable register
Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIS

R

Receive FIFO full interrupt status

3

RXOIS

R

Receive FIFO overflow interrupt status

2

RXUIS

R

Receive FIFO overflow interrupt status

1

TXOIS

R

Send FIFO overflow interrupt status

0

TXEIS

R

Send FIFO null interrupt status

22.9.11.

Description

Raw interrupt status register (SPI_RISR)
Address offset: 0x034
Reset value: 0x0000_0000
Description: This status register ignores the interrupt enable register

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIR

R

Receive FIFO full raw interrupt status

3

RXOIR

R

Receive FIFO overflow raw interrupt status

2

RXUIR

R

Receive FIFO overflow raw interrupt status

1

TXOIR

R

Send FIFO overflow raw interrupt status

0

TXEIR

R

Send FIFO null raw interrupt status

22.9.12.

Description

Transmit Overflow interrupt clear register (SPI_TXOICR)
Address offset: 0x038
Reset value: 0x0000_0000
Description: Reading this register will clear the overflow interrupt on the send FIFO

Bits

Fields

R/W

31:1

-

Res

Reserved

R

Clear Transmit FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

0

22.9.13.

TXOICR

Description

Receive Overflow interrupt clear register (SPI_RXOICR)
Address offset: 0x03C
Reset value: 0x0000_0000
Description: Reading this register will clear the overflow interrupt on the receive FIFO

Doc ID 2905025

Rev01

303

WB32FQ95xx Reference Manual

Bits

Fields

R/W

31:1

-

Res

Reserved

0

RXOICR

R

Clear Receive FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

22.9.14.

Description

Receive underflow interrupt clear register (SPI_RXUICR)
Address offset: 0x040
Reset value: 0x0000_0000
Description:Reading this register will clear the receive FIFO

underflow interrupt

Bits

Fields

R/W

31:1

-

Res

Reserved

0

RXUICR

R

Clear Receive FIFO Underflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

22.9.15.

Description

Interrupt clear register (SPI_ICR)
Address offset: 0x048
Reset value: 0x0000_0000
Description: Reading this register will clear the overflow interrupt on the transmit FIFO, the
overflow interrupt on the receive FIFO and the overflow interrupt under the receive FIFO at
the same time Underflow interrupt

Bits

Fields

R/W

31:1

-

Res

Reserved

0

ICR

R

Clear interrupt

22.9.16.

Description

DMA ENABLE register (SPI_DMACR)
Address offset: 0x04C
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

1

TDMAE

RW

0

RDMAE

RW

Doc ID 2905025

Description
Reserved
DMA Send enable
This bit enables/disables the transmit FIFO DMA channel.
0: DISABEL DMA transmission
1: ENABLE DMA transmission
DMA Receive enable
This bit enables/disables the receive FIFO DMA channel.
0: DISABEL DMA receive
1: ENABLE DMA receive

Rev01

304

WB32FQ95xx Reference Manual

22.9.17.

DMA TX threshold register (SPI_DMATDLR)
Address offset: 0x050
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMATDLR

RW

DMA TX threshold

22.9.18.

Description

DMA RX threshold register (SPI_DMARDLR)
Address offset: 0x054
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMARDL

RW

DMA RX threshold

22.9.19.

Description

SPI Data register (SPI_DR)
Address offset: 0x060 to 0x0EC
Reset value: 0x0000_0000
Description: The DR register is a continuous address space. Writing to this space will send
the data into the transmit FIFO; reading from this space will read out the data in the receive
FIFO in order.

Bits

Fields

R/W

Description

31:16

-

Res

Reserved

15:0

DR

RW

SPI data
Writing this register will store the data in the send FIFO
Reading this register will read data from the receive FIFO

22.10.

SPI master mode register

22.10.1.

SPI Control register0 (SPI_CR0)
Address offset: 0x000
Reset value: 0x0100_0007
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:25

-

Res

Reserved

24

SSTE

RW

When CPHA = 0, SSTE sets the state of SSN signal between data frames.
SSTE = 1: SSN remains 1 between two consecutive data frames.
SSTE = 0: SSN remains 0 between two consecutive data frames

23:16

-

Res

Reserved

Doc ID 2905025

Description

Rev01

305

WB32FQ95xx Reference Manual

Bits

Fields

R/W

Description

15:12

CFS

RW

Control Frame Size. Selects the length of the control word for the Microwire
frame format.
0000: The control word is 1 bit
0001: The control word is 2 bit
0010: The control word is 3bit
.............
1111: The control word is 16 bit

11:10

-

Res

Reserved

9:8

TMOD

RW

7

CPOL

RW

6

CPHA

RW

5:4

FRF

RW

3:0

DFS

RW

22.10.2.

Transfer Mode.
Selects the mode of transfer for serial communication. This field does not
affect the transfer duplicity. Only indicates whether the receive or transmit
data are valid.
00: Both Transfer and receiving are valid
01: Send only valid
10: Receive only valid
11: Invalid setting, setting to 11 is not allowed
Clock polarity
0: In idle state, SCLK remains low
1: In idle state, SCLK remains high
Serial Clock phase
0: Data sampling starts at the edge of the first clock
1: Data sampling starts at the edge of the second clock
Protocol selection
00: Motorola SPI Protocol
01: Texas Instruments SSP Protocol
10: National Semiconductor MICROWIRE Protocol
11: Invalid setting, setting to 11 is not allowed
Data frame length
0000: Invalid setting, setting to 0000 is not allowed
0001: Invalid setting, setting to 0001 is not allowed
0010: Invalid setting, setting to 0010 is not allowed
0011: The data frame length is 4bit
0100: The data frame length is 5bit
0101: The data frame length is 6bit
.............
1111: The data frame length is 16bit

SPI Control Register 1(SPI_CR1)
Address offset: 0x004
Reset value: 0x0000_0000
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:16

-

Res

Reserved

15:0

NDF

RW

Maximum data Received continuously when TMOD=10.

22.10.3.

Description

SPI Enable Register (SPI_SPIENR)
Address offset: 0x008

Doc ID 2905025

Rev01

306

WB32FQ95xx Reference Manual

Reset value: 0x0000_0000
Bits

Fields

R/W

31:1

-

Res

Reserved

0

SPI_EN

RW

SPI enable

22.10.4.

Description

MICROWIRE Control Register (SPI_MWCR)
Address offset: 0x00C
Reset value: 0x0000_0000
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:3

-

Res

2

MHS

RW

1

MDD

RW

0

MWMOD

RW

22.10.5.

Description
Reserved
Handshake control
0: Handshake prohibited
1: handshake Allow
Data transmission
0: receive data
1: transmission data
Continuous transmission control
0: Single transmission
1: Continuous transmission

Slave Select Register (SPI_SER)
Address offset: 0x010
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

2

SE2

RW

1

SE1

RW

0

SE0

RW

22.10.6.

Description
Reserved
Device 2 selection
0: Unchecked
1: Select the slave device
Device 1 selection
0: Unchecked
1: Select the slave device
Device 0 selection
0: Unchecked
1: Select the slave device

Baud Rate Register (SPI_BAUDR)
Address offset: 0x014
Reset value: 0x0000_0000
Description: The output SCLK clock of master device is obtained by SPI master device input
clock (SPICLK). When SPI is enabled in SPI_SPIENR, this register cannot be written.

Doc ID 2905025

Rev01

307

WB32FQ95xx Reference Manual

Bits

Fields

R/W

31:16

-

Res

Reserved

15:0

SCKDV

RW

Frequency division ratio: calculate the frequency of output SCLK clock
according to the following formula FSCLK= FSPI_CLK/ SCKDV

22.10.7.

Description

TX FIFO Threshold Register (SPI_TXFTLR)
Address offset: 0x018
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

TFT

RW

TX FIFO threshold
Controls the level of entries (or below) at which the transmit FIFO controller
triggers an interrupt.

22.10.8.

Description

RX FIFO Threshold Register (SPI_RXFTLR)
Address offset: 0x01C
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

RFT

RW

Receive FIFO threshold
Controls the level of entries (or above) at which the receive FIFO controller
triggers an interrupt.

22.10.9.

Description

TX FIFO Status Register (SPI_TXFLR)
Address offset: 0x020
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

TXTFL

R

Contains the number of valid data entries in the transmit FIFO.

22.10.10.

Description

RX FIFO Status Register (SPI_RXFLR)
Address offset: 0x024
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

RXTFL

R

Contains the number of valid data entries in the receive FIFO.

Doc ID 2905025

Description

Rev01

308

WB32FQ95xx Reference Manual

22.10.11.

SPI Status Register (SPI_SR)
Address offset: 0x028
Reset value: 0x0000_0006

Bits

Fields

R/W

31:6

-

Res

Reserved

5

TXERR

RC_R

When the transmit FIFO is empty and transmit is started, it will be set to 1.
Reading this register will clear this bit

4

RFF

R

Set 1 when the receive FIFO is full and 0 when the receive FIFO is not full

3

RFNE

R

2

TFE

R

1

TFNF

R

Set 1 when the transmit FIFO is not full and 0 when the transmit FIFO is full

0

BUSY

R

Set 1 when transmission is in progress and 0 when all transmission ends

22.10.12.

Description

Set 1 when the receive FIFO is not empty and 0 when the receive FIFO is
empty
Set 1 when the transmit FIFO is empty and 0 when the transmit FIFO is not
empty

Interrupt enable register (SPI_IER)
Address offset: 0x02C
Reset value: 0x0000_001F

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIE

RW

Write 0 to mask receive FIFO full interrupt

3

RXOIE

RW

Write 0 to mask receive FIFO overflow interrupt

2

RXUIE

RW

Write 0 to mask receive FIFO underflow interrupt

1

TXOIE

RW

Writing 0 masks the overflow interrupt on the send FIFO

0

TXEIE

RW

Write 0 to mask send FIFO null interrupt

22.10.13.

Description

Interrupt status register (SPI_ISR)
Address offset: 0x030
Reset value: 0x0000_0000
Description: This status register is affected by the interrupt enable register (SPI_IER)

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIS

R

Receive FIFO full interrupt status

3

RXOIS

R

Overflow interrupt on receive FIFO status

2

RXUIS

R

Receive FIFO underflow interrupt status

1

TXOIS

R

Send FIFO overflow interrupt status

0

TXEIS

R

Send FIFO null interrupt status

Doc ID 2905025

Description

Rev01

309

WB32FQ95xx Reference Manual

22.10.14.

Raw interrupt status register (SPI_RISR)
Address offset: 0x034
Reset value: 0x0000_0000
Description: This status register ignores the interrupt enable register (SPI_ IER)

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIR

R

Receive FIFO full raw interrupt status

3

RXOIR

R

Receive FIFO overflow raw interrupt status

2

RXUIR

R

Receive FIFO underflow raw interrupt status

1

TXOIR

R

Send FIFO overflow raw interrupt status

0

TXEIR

R

Send FIFO null raw interrupt status

22.10.15.

Description

Overflow interrupt clear register (SPI_TXOICR)
Address offset: 0x038
Reset value: 0x0000_0000
Description: Reading this register will clear send FIFO overflow interrupt

Bits

Fields

R/W

31:1

-

Res

Reserved

0

TXOICR

R

Clear Transmit FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

22.10.16.

Description

RX Overflow interrupt clear register (SPI_RXOICR)
Address offset: 0x03C
Reset value: 0x0000_0000
Description: Overflow interrupt clear register on receive FIFO

Bits

Fields

R/W

31:1

-

Res

Reserved

0

RXOICR

R

Clear Receive FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

22.10.17.

Description

RX underflow interrupt clear register (SPI_RXUICR)
Address offset: 0x040
Reset value: 0x0000_0000
Description: Reading this register will clear receive FIFO underflow interrupt

Doc ID 2905025

Rev01

310

WB32FQ95xx Reference Manual

Bits

Fields

R/W

31:1

-

Res

Description
Reserved
Clear Receive FIFO Underflow Interrupt.

0

RXUICR

R

This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

22.10.18.

Interrupt clear register (SPI_ICR)
Address offset: 0x048
Reset value: 0x0000_0000
Description: Reading this register will clear the transmit FIFO overflow interrupt, receive
FIFO overflow interrupt and receive FIFO underflow interrupt at the same time

Bits

Fields

R/W

31:1

-

Res

Reserved

0

ICR

R

Clear interrupt

22.10.19.

Description

DMA Enable register (SPI_DMACR)
Address offset: 0x04C
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Description
Reserved
DMA transmission enable

1

TDMAE

RW

0: disable DMA transmission
1: enable DMA transmission
DMA receive enable

0

RDMAE

RW

0: disable DMA receive
1: enable DMA receive

22.10.20.

DMA TX threshold register (SPI_DMATDLR)
Address offset: 0x050
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMATDL

RW

DMA TX threshold setting

22.10.21.

Description

DMA RX threshold register (SPI_DMARDLR)
Address offset: 0x054
Reset value: 0x0000_0000

Doc ID 2905025

Rev01

311

WB32FQ95xx Reference Manual

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMARDL

RW

DMA RX threshold setting

22.10.22.

Description

SPI Data register (SPI_DR)
Address offset: 0x060 to 0x0EC
Reset value: 0x0000_0000
Description: DR register is a continuous address space. Writing to this space will store data
into the transmit FIFO in order, Read from this space reads the data in the receive FIFO
sequentially.

Bits

Fields

R/W

31:16

-

Res

Reserved

RW

SPI Data
Writing this register will store the data in the send FIFO
Reading this register will read data from the receive FIFO

15:0

DR

Doc ID 2905025

Description

Rev01

312

WB32FQ95xx Reference Manual

23.

4-wire serial peripheral interface (QSPI)

23.1.

Introduction
QSPI is a SPI master mode device with four data lines, which is a special SPI protocol and
also supports standard SPI protocol.

23.2.

QSPI features
⚫

APB interface

⚫

Support DMA transmission

⚫

Two data FIFO s with depth of 10 and width of 16 bits, corresponding to Transfer and
receiving respectively

⚫

Four configurable clock modes

⚫

The data format is right aligned

⚫

Support up to three 4-wire SPI slave mode devices

⚫

Support standard SPI protocol (please refer to the chapter "serial peripheral interface
SPI")
Figure 23-1. QSPI connection diagram

23.3.

Clock phase and clock polarity
Four possible timing relationships can be chosen by software，Please refer to SPI section:
⚫

CPOL,CPHA = 00

⚫

CPOL,CPHA = 01

⚫

CPOL,CPHA = 10

⚫

CPOL,CPHA = 11

Doc ID 2905025

Rev01

313

WB32FQ95xx Reference Manual

23.4.

Transfer Modes
When transmitting data on the serial bus, three transfer modes are supported, which is
controlled by TMOD bit of register SPI_CR0.
Transmit & Receive
When TMOD = 2‘b00, both transmit and receive logic are valid. The data transfer occurs as
normal according to the selected frame format (serial protocol). Transmit data are popped
from the transmit FIFO and sent through the TXD line to the target device, which replies with
data on the RXD line. The receive data from the target device is moved from the receive shift
register into the receive FIFO at the end of each data frame.
Transmit Only
When TMOD = 2‘b01, the receive data are invalid and should not be stored in the receive
FIFO. The data transfer occurs as normal, according to the selected frame format (serial
protocol). Transmit data are popped from the transmit FIFO and sent through the TXD line to
the target device, which replies with data on the RXD line. At the end of the data frame, the
receive shift register does not load its newly received data into the receive FIFO. The data in
the receive shift register is overwritten by the next transfer. You should mask interrupts
originating from the receive logic when this mode is entered.
Receive Only
When TMOD = 2‘b10, the transmit data are invalid. When configured as a slave, the transmit
FIFO is never popped in Receive Only mode. The TXD output remains at a constant logic
level during the transmission. The data transfer occurs as normal according to the selected
frame format (serial protocol). The receive data from the target device is moved from the
receive shift register into the receive FIFO at the end of each data frame. You should mask
interrupts originating from the transmit logic when this mode is entered.

23.5.

QSPI Master Mode
QSPI needs to control the SCLK clock, and it must pass the register QSPI first_ BAUDR
configures the baud rate of the master mode.
QSPI can output three SSN signals, corresponding to up to three external slave mode
devices.
GPIO configuration
To use QSPI, the following GPIO should be configured first (please refer to the GPIO register
section)
⚫

SSN0 corresponds to GPIOA port 4 or GPIOA port 15, and the alternate mode of the
port is configured to 5

⚫

SSN1 corresponds to GPIOA port 13 or GPIOB port 6, and the alternate mode of this
port is configured to 5

⚫

SSN2 corresponds to GPIOA port 14 or GPIOB port 10, and the alternate mode of this
port is configured as 5

⚫

SCLK corresponds to GPIOA port 5 or GPIOB port 3, and the alternate mode of the
port is configured to 5

Doc ID 2905025

Rev01

314

WB32FQ95xx Reference Manual

⚫

MO_IO0 corresponds to GPIOA port 7 or GPIOB port 5, and the alternate mode of this
port is configured to 5

⚫

MI_IO1 corresponds to GPIOA port 6 or GPIOB port 4, and the alternate mode of this
port is configured to 5

⚫

IO2 corresponds to GPIOB port 0, and the alternate mode of this port is configured to 5

⚫

IO3 corresponds to GPIOB port 1, and the alternate mode of this port is configured to 5

The QSPI master device will send QSPI instructions to the slave device first, and then send
the address to be read and written (the instructions and addresses are collectively called
control frames), and then send the QSPI instructions to the slave device
For the master SPI/SSP/Microwire serial transfers, please refer to section 23.6 for detail info.
They are similar.
Data is sent to or received by the slave device.

23.6.

DMA transmission
Transfer and receiving both support DMA transmission, and users can set DMA threshold
separately for Transfer and receiving to trigger DMA transmission.
DMA TX threshold: via register QSPI_ DMATDLR, when the amount of data in the transmit
FIFO is equal to or less than the DMA TX FIFO Threshold, a DMA request will be
generated to the DMA controller on the bus.
DMA RX threshold: through register QSPI_ DMATDLR, when the amount of data in the
receive FIFO is equal to or greater than the DMA RX FIFO Threshold, a DMA request is
generated to the DMA controller on the bus

23.7.

Interrupt
QSPI has five interrupt sources, but only one interrupt output. When the CPU receives the
interrupt, it needs to read the QSPI interrupt register to determine the interrupt source.
Interrupt source:
⚫

Send FIFO empty: occurs when the data to be sent in the send FIFO is equal to or less
than the set threshold

⚫

Overflow: occurs when the transmit FIFO is full and new data is attempted to be written
from the APB bus

⚫

Full receive FIFO: when the data stored in the receive FIFO is equal to or greater than
the set threshold

⚫

Overflow of receive FIFO: occurs when the receive FIFO is full and new data is
Received

⚫

Underflow: occurs when the receive FIFO is empty and an attempt is made to read data
from the APB bus

FIFO Threshold:
You can set thresholds for send FIFO and receive FIFO to better control the amount of data.
If you do not set thresholds, the default threshold is the maximum capacity of send FIFO and
receive FIFO.

Doc ID 2905025

Rev01

315

WB32FQ95xx Reference Manual

23.8.

QSPI Master Mode Register

23.8.1.

QSPI Control Register 0(QSPI_CR0)
Address offset: 0x000
Reset value: 0x0100_0007
Description: When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

Description

31:25

-

Res

Reserved

24

SSTE

RW

When CPHA = 0, SSTE sets the state of SSN signal between data frames.
SSTE = 1: SSN remains 1 between two consecutive data frames.
SSTE = 0: SSN remains 0 between two consecutive data frames

23

-

Res

Reserved

22:21

SPI_MODE

RW

SPI mode select
00: Standard SPI mode
01: Dual line SPI mode (Dual)
10: Four wire SPI mode (Quad)
11: Reserved

20:10

-

Res

Reserved

9:8

TMOD

RW

7

CPOL

RW

6

CPHA

RW

5:4

FRF

RW

3:0

DFS

RW

23.8.2.

Control Frame Size. Selects the length of the control word for the Microwire
frame format.
00: both Transfer and receiving are valid
01: send only valid
10: Receive only valid
11: Invalid setting, setting to 11 is not allowed
Clock polarity
0: SCLK remains low in idle state
1: In idle state, SCLK remains high
Clock phase
0: data sampling starts from the first clock edge
1: Data sampling starts at the edge of the second clock
Protocol selection
00: Motorola SPI protocol
01: Texas Instruments SSP protocol
10: Invalid setting, setting to 10 is not allowed
11: Invalid setting, setting to 11 is not allowed
The data frame length must be a multiple of 4
0000: invalid setting, setting to 0000 is not allowed
0001: invalid setting, setting to 0001 is not allowed
0010: invalid setting, setting to 0010 is not allowed
0011: the data frame length is 4 bits
0100: the data frame length is 5bit
0101: the data frame length is 6bit
.............
1111: the data frame length is 16bit

QSPI Control register 1(QSPI_CR1)
Address offset: 0x004

Doc ID 2905025

Rev01

316

WB32FQ95xx Reference Manual

Reset value: 0x0000_0000
Description: This register only works when TMOD = 10 and is used to set the maximum
amount of data continuously Received. When SPI is enabled in SPI_SPIENR, this register
cannot be written.
Bits

Fields

R/W

31:16

-

Res

Reserved

15:0

NDF

RW

Maximum amount of data continuously Received

23.8.3.

Description

QSPI Enable register (QSPI_SPIENR)
Address offset: 0x008
Reset value: 0x0000_0000

Bits

Fields

R/W

31:1

-

Res

Reserved

0

SPI_EN

RW

QSPI ENABLE

23.8.4.

Description

Slave select register (QSPI_SER)
Address offset: 0x010
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Description
Reserved
device 2 selection

2

SE2

RW

0: not selected
1: Select the slave device
device 1 selection

1

SE1

RW

0: not selected
1: Select the slave device
device 0 selection

0

SE0

RW

0: not selected
1: Select the slave device

23.8.5.

Baud rate register (QSPI_BAUDR)
Address offset: 0x014
Reset value: 0x0000_0000
Description: The SCLK clock of QSPI output is controlled by the input clock (QSPI_CLK)
frequency division. When SPI is enabled in SPI_SPIENR, this register cannot be written.

Bits

Fields

R/W

31:16

-

Res

Reserved

15:0

SCKDV

RW

Frequency division ratio: calculate the frequency of output SCLK clock
according to the following formula fSCLK = fQSPI_CLK / SCKDV

Doc ID 2905025

Description

Rev01

317

WB32FQ95xx Reference Manual

23.8.6.

TX FIFO threshold register (QSPI_TXFTLR)
Address offset: 0x018
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

TFT

RW

TX FIFO threshold
Controls the level of entries (or below) at which the transmit FIFO controller
triggers an interrupt.

23.8.7.

Description

RX FIFO threshold register (QSPI_RXFTLR)
Address offset: 0x01C
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

RFT

RW

Receive FIFO threshold
Controls the level of entries (or above) at which the receive FIFO controller
triggers an interrupt.

23.8.8.

Description

TX FIFO status register (QSPI_TXFLR)
Address offset: 0x020
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

TXTFL

R

Contains the number of valid data entries in the transmit FIFO.

23.8.9.

Description

RX FIFO status register (QSPI_RXFLR)
Address offset: 0x024
Reset value: 0x0000_0000

Bits

Fields

R/W

31:3

-

Res

Reserved

2:0

RXTFL

R

Contains the number of valid data entries in the receive FIFO.

23.8.10.

Description

QSPI Status register (QSPI_SR)
Address offset: 0x028
Reset value: 0x0000_0006

Bits

Fields

R/W

31:6

-

Res

Doc ID 2905025

Description
Reserved

Rev01

318

WB32FQ95xx Reference Manual

Bits

Fields

R/W

Description

5

TXERR

RC_R

When the transmit FIFO is empty but transmit is started, it will be set to 1.
Reading this register will clear this bit

4

RFF

R

Set 1 when the receive FIFO is full and 0 when the receive FIFO is not full

3

RFNE

R

2

TFE

R

1

TFNF

R

Set 1 when the transmit FIFO is not full and 0 when the transmit FIFO is full

0

BUSY

R

Set 1 when transmission is in progress and 0 when all transmission ends

23.8.11.

Set 1 when the receive FIFO is not empty and 0 when the receive FIFO is
empty
Set 1 when the transmit FIFO is empty and 0 when the transmit FIFO is not
empty

Interrupt enable register (QSPI_IER)
Address offset: 0x02C
Reset value: 0x0000_001F

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIE

RW

Write 0 to mask receive FIFO full interrupt

3

RXOIE

RW

Write 0 to mask receive FIFO overflow interrupt

2

RXUIE

RW

Write 0 to mask receive FIFO underflow interrupt

1

TXOIE

RW

0

TXEIE

RW

23.8.12.

Description

Writing 0 masks the overflow interrupt on the send FIFO
Write 0 to mask send FIFO null interrupt

Interrupt status register (QSPI_ISR)
Address offset: 0x030
Reset value: 0x0000_0000
Description: This status register is affected by the interrupt enable register (QSPIIER)

Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIS

R

Receive FIFO full interrupt status

3

RXOIS

R

Receive FIFO overflow interrupt status

2

RXUIS

R

Receive FIFO underflow interrupt status

1

TXOIS

R

Send FIFO overflow interrupt status

0

TXEIS

R

Send FIFO null interrupt status

23.8.13.

Description

Raw interrupt status register (QSPI_RISR)
Address offset: 0x034
Reset value: 0x0000_0000

Doc ID 2905025

Rev01

319

WB32FQ95xx Reference Manual

Description: This status register ignores the interrupt enable register (QSPIIER)
Bits

Fields

R/W

31:5

-

Res

Reserved

4

RXFIR

R

Receive FIFO full full raw interrupt status

3

RXOIR

R

Receive FIFO overflow full raw interrupt status

2

RXUIR

R

Receive FIFO underflow full raw interrupt status

1

TXOIR

R

Send FIFO overflow full raw interrupt status

0

TXEIR

R

Send FIFO null full raw interrupt status

23.8.14.

Description

TX overflow interrupt clear register (QSPI_TXOICR)
Address offset: 0x038
Reset value: 0x0000_0000

Bits

Fields

R/W

31:1

-

Res

Reserved

R

Clear Transmit FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

0

TXOICR

Description

Description: Reading this register will clear the send FIFO overflow interrupt

23.8.15.

RX overflow interrupt clear register (QSPI_RXOICR)
Address offset: 0x03C
Reset value: 0x0000_0000
Description: Reading this register will clear the receive FIFO overflow interrupt

Bits

Fields

R/W

31:1

-

Res

Reserved

R

Clear Receive FIFO Overflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

0

23.8.16.

RXOICR

Description

Receive underflow interrupt clear register (QSPI_RXUICR)
Address offset: 0x040
Reset value: 0x0000_0000
Description: Reading this register will clear the receive FIFO underflow interrupt

Bits

Fields

R/W

31:1

-

Res

Reserved

R

Clear Receive FIFO Underflow Interrupt.
This register reflects the status of the interrupt. A read from this register
clears the interrupt; writing has no effect.

0

RXUICR

Doc ID 2905025

Description

Rev01

320

WB32FQ95xx Reference Manual

23.8.17.

Interrupt clear register (QSPI_ICR)
Address offset: 0x048
Reset value: 0x0000_0000
Description: Reading this register will clear the transmit FIFO overflow interrupt, receive
FIFO overflow interrupt and receive FIFO underflow interrupt at the same time

Bits

Fields

R/W

31:1

-

Res

Reserved

0

ICR

R

Clear interrupt

23.8.18.

Description

DMA Enable register (QSPI_DMACR)
Address offset: 0x04C
Reset value:0x0000_0000

Bits

Fields

R/W

31:2

-

Res

1

TDMAE

RW

0

RDMAE

RW

23.8.19.

Description
Reserved
DMA Send enable
0: disable DMA transmission
1: allow DMA transmission
DMA Receive enable
0: disable DMA receive
1: enable DMA receive

DMA TX threshold register (QSPI_DMATDLR)
Address offset: 0x050
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMATDL

RW

DMA TX threshold setting

23.8.20.

Description

DMA RX threshold register (QSPI_DMARDLR)
Address offset: 0x054
Reset value: 0x0000_0000

Bits

Fields

R/W

31:2

-

Res

Reserved

1:0

DMARDL

RW

DMA RX threshold setting

23.8.21.

Description

QSPI Data register (QSPI_DR)
Address offset: 0x060 to 0x0EC

Doc ID 2905025

Rev01

321

WB32FQ95xx Reference Manual

Reset value: 0x0000_0000
Description: The DR register is a continuous address space. Writing to this address will store
data into the transmit FIFO; reading from this space will read out the data in the receive
FIFO.
Bits

Fields

R/W

31:16

-

Res

Reserved

RW

QSPI Data
Writing this register will store the data in the send FIFO
Reading this register will read data from the receive FIFO

15:0

23.8.22.

DR

Description

QSPI Enhanced mode configuration register (QSPI_ESPICR)
Address offset: 0x0F4
Reset value: 0x0000_0200

Bits

Fields

R/W

Description

31:16

-

Res

Reserved

15:11

WCYC

RW

QSPI waiting time
When receiving, the QSPI master device needs a waiting time after Transfer
the control frame (instruction and address). The slave device can receive
the data only after the slave device is ready. The waiting time takes the
SCLK cycle as a single bit

10

-

Res

Reserved

9:8

INSTL

RW

Instruction length
00: 0 bit,It means that there is no need to send instructions
01: 4 Bit instruction
10: 8 Bit instruction
11: 16 Bit instruction

7:6

-

Res

Reserved

5:2

ADDRL

RW

1:0

TRANST

RW

Doc ID 2905025

Address length
0000: 0 bit,This means that the Transfer address is not required
0001: 4 Bit address
0010: 8 Bit address
0011: 12 Bit address
0100: 16 Bit address
0101: 20 Bit address
0110: 24 Bit address
0111: 28 Bit address
1000: 32 Bit address
1001: 36 Bit address
1010: 40 Bit address
1011: 44 Bit address
1100: 48 Bit address
1101: 52 Bit address
1110: 56 Bit address
1111: 60 Bit address
Control frame transmission format
00: Instructions and addresses are delivered in standard SPI format (single
line SPI)
01: the instruction is sent in standard SPI format (one line SPI) and the
address is sent in QSPI (four line SPI)
10: Instructions and addresses are sent in QSPI (4-wire SPI)
11: Setting to 11 is not allowed

Rev01

322

